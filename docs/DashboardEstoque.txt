Tela: Dashboard de Estoque
=========================

Visao geral
-----------
- Consolida indicadores de movimentacao de estoque (entradas, saidas, saldo e valor movimentado) no periodo filtrado.
- Exibe series historicas, rankings e graficos de Pareto (quantidade, risco operacional e financeiro).
- Permite gerar relatorio mensal ou trimestral e enviar por email para administradores.
- Fonte principal: `api.estoque.dashboard` e `api.estoque.report` via `dashboardEstoqueApi`.

Arquitetura
-----------
- Hook `useDashboardEstoque`:
  - Mantem filtros, dados, estado de loading/erro.
  - Monta series historicas, rankings e calcula Pareto/risco operacional.
  - Dispara geracao de relatorio via `generateDashboardEstoqueReport`.
- Contexto `DashboardEstoqueProvider`:
  - Expoe o estado do hook, funcoes de recarregar e mensagens de ajuda dos graficos.
- Componentes de grafico:
  - `ParetoChart` (novo) para curva 80/20, risco e financeiro.
  - `ChartExpandModal` para visualizar graficos em tela cheia.
- Backend:
  - `EstoqueOperations.report` gera o relatorio, grava em `inventory_report` e envia email via Brevo.
  - `EstoqueOperations.reportAuto` gera relatorios mensais/trimestrais via cron.
  - Templates em `shared/documents` alimentam os textos enviados por email.
- Erros:
  - `useErrorLogger('dashboard_estoque')` registra falhas de carga e geracao de relatorio.

Filtros, auto-complete e listagem
---------------------------------
- Periodo inicial/final (AAAA-MM).
- Termo livre (material, fabricante, categoria, centro, setor, pessoa).
- Aplicacao sob demanda: filtros sao aplicados apenas ao clicar em **Aplicar filtros**.
- Filtro contextual por grafico:
  - Clique em um grafico aplica `chartFilter` (ex.: filtrar por um centro ou categoria).
  - Badge "Limpar" remove o filtro contextual.

Boas praticas
-------------
- Garantir `valorUnitario` e `validadeDias` nos materiais para calculos financeiros e pressao de vida util.
- Preencher `grupoMaterial` para classificar EPI/EPC no risco operacional.
- Manter `dataTroca` consistente nas saidas para vencidos/vencendo.
- Respeitar `account_owner_id` em todas as consultas (multi-tenant).
- Pareto 80/20 responde: "O que mais sai fisicamente?".
- Pareto por risco operacional responde: "O que nao pode faltar de jeito nenhum?".
- Pareto financeiro responde: "O que doi mais no caixa?".

Atualizacao 2026-02
-------------------
- Adicionados graficos de Pareto (quantidade, risco e financeiro) no dashboard.
- Relatorios mensais e trimestrais com envio por email e persistencia em `inventory_report`.
- Templates TXT criados em `shared/documents` para relatorios mensais e trimestrais.
- Ajustado espacamento e labels do Pareto para manter o grafico dentro do card.
- Labels de materiais agora incluem numero/tamanho para evitar duplicidade visual.
- IDs de tamanho/numero nao sao exibidos; usa nome legivel quando disponivel.
- Tooltip e legenda dos Paretos de quantidade/risco agora mostram "Quantidade" em vez de "Valor".
- Tooltip dos graficos de materiais mostra descricao completa, ID e quantidade.
- Pareto consolida itens repetidos pelo mesmo materialId antes de ordenar.
- Dashboard aplica filtro de itens unicos por materialId nos Paretos exibidos.
- SaidasResumo normaliza chave por materialId para evitar duplicidade visual.
- Pareto usa ordenacao deterministica (quantidade desc + materialId asc) para evitar troca de posicoes.
- Mensagens de ajuda do dashboard atualizadas com as perguntas do Pareto.
- Antes/Depois:
  - Antes: dashboard sem Pareto e sem relatorio persistido; labels longos encostavam no card e itens com mesmo nome confundiam.
  - Depois: Pareto ativo + relatorios gerados, enviados e gravados por execucao; labels truncados, margens internas maiores e numero/tamanho no nome.
- Arquivos alterados/criados:
  - `src/pages/DashboardPage.jsx`
  - `src/hooks/useDashboardEstoque.js`
  - `src/components/charts/ParetoChart.jsx`
  - `src/utils/inventoryReportUtils.js`
  - `src/services/dashboardEstoqueApi.js`
  - `src/services/api.js`
  - `src/services/localApi.js`
  - `src/utils/dashboardEstoqueUtils.js`
  - `api/_shared/operations.js`
  - `api/index.js`
  - `api/_shared/withAuth.js`
  - `shared/documents/RELATÓRIO MENSAL DE ESTOQUE.txt`
  - `shared/documents/RELATÓRIO TRIMESTRAL DE ESTOQUE (COMPARATIVO).txt`
  - `supabase/migrations/20260201_create_inventory_report.sql`

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- DashboardPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/DashboardPage.jsx
  - Responsavel por: orquestrar filtros, cards, graficos e botao de relatorio.
- useDashboardEstoque
  - Tipo: hook de dados/dashboard
  - Caminho: src/hooks/useDashboardEstoque.js
  - Responsavel por: carregar dados, calcular Pareto/risco e disparar relatorio.
- ParetoChart
  - Tipo: componente de grafico
  - Caminho: src/components/charts/ParetoChart.jsx
  - Responsavel por: exibir barras + curva acumulada (80/20).
- EstoqueOperations.report/reportAuto
  - Tipo: operacao backend
  - Caminho: api/_shared/operations.js
  - Responsavel por: gerar relatorio, gravar no banco e enviar email.

Constantes e configuracoes
--------------------------
- chartInfoMessagesEstoque
  - Tipo: configuracao de ajuda
  - Caminho: src/utils/dashboardEstoqueUtils.js
  - Uso: mensagens dos botoes de info dos graficos.
- DEFAULT_RISK_WEIGHTS / DEFAULT_RISK_THRESHOLDS
  - Tipo: configuracao de risco
  - Caminho: src/utils/inventoryReportUtils.js
  - Uso: peso e corte para classificacao de risco operacional.

Funcoes utilitarias relacionadas
--------------------------------
- buildParetoList / buildRiscoOperacional / computePercentile
  - Tipo: utilitarios
  - Caminho: src/utils/inventoryReportUtils.js
  - Responsavel por: gerar Pareto, risco e percentis.
- builders de series/rankings
  - Tipo: utilitarios
  - Caminho: src/utils/dashboardEstoqueUtils.js
  - Responsavel por: formatar valores, montar series historicas e rankings.

Servicos e integracoes externas
-------------------------------
- dashboardEstoqueApi
  - Tipo: servico de API
  - Caminho: src/services/dashboardEstoqueApi.js
  - Responsavel por: buscar dashboard e gerar relatorio.
- Brevo (email)
  - Tipo: integracao externa
  - Caminho: api/_shared/operations.js
  - Responsavel por: envio de relatorios via `BREVO_API_KEY`.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpDashboard.json (chave 'dashboard').
