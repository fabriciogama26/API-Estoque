Tela: Dashboard de Estoque
=========================

Visao geral
-----------
- Consolida indicadores de movimentacao de estoque (entradas, saidas, saldo e valor movimentado) no periodo filtrado.
- Exibe series historicas e rankings de movimentacao.
- Paretos e interpretacoes foram movidos para a pagina "Analise de Estoque".
- Relatorios mensais sao gerados automaticamente e enviados por email somente para o ultimo mes gerado.
- Fonte principal: `api.estoque.dashboard` e `api.estoque.report` via `dashboardEstoqueApi`.

Arquitetura
-----------
- Hook `useDashboardEstoque`:
  - Mantem filtros, dados, estado de loading/erro.
  - Monta series historicas e rankings.
  - Dispara geracao de relatorio via `generateDashboardEstoqueReport`.
- Contexto `DashboardEstoqueProvider`:
  - Expoe o estado do hook, funcoes de recarregar e mensagens de ajuda dos graficos.
- Componentes de grafico:
  - `ChartExpandModal` para visualizar graficos em tela cheia.
- Backend:
  - `EstoqueOperations.report` gera o relatorio e grava em `inventory_report` (sem envio de email).
  - `EstoqueOperations.reportAuto` gera relatorios mensais via cron (sem envio de email).
  - Edge Functions `relatorio-estoque-mensal` e `relatorio-estoque-mensal-email` fazem geracao e envio.
- Erros:
  - `useErrorLogger('dashboard_estoque')` registra falhas de carga e geracao de relatorio.

Filtros, auto-complete e listagem
---------------------------------
- Periodo inicial/final (AAAA-MM).
- Termo livre (material, fabricante, categoria, centro, setor, pessoa).
- Aplicacao sob demanda: filtros sao aplicados apenas ao clicar em **Aplicar filtros**.
- Filtro contextual por grafico:
  - Clique em um grafico aplica `chartFilter` (ex.: filtrar por um centro ou categoria).
  - Badge "Limpar" remove o filtro contextual.

Boas praticas
-------------
- Garantir `valorUnitario` e `validadeDias` nos materiais para calculos financeiros e pressao de vida util.
- Preencher `grupoMaterial` para classificar EPI/EPC no risco operacional.
- Manter `dataTroca` consistente nas saidas para vencidos/vencendo.
- Filtros de periodo afetam consumo, nao afetam estoque atual (sempre acumulado).
- Respeitar `account_owner_id` em todas as consultas (multi-tenant).

Atualizacao 2026-02
-------------------
- Paretos movidos para a pagina "Analise de Estoque".
- Relatorios mensais com envio por email e persistencia em `inventory_report`.
- Templates TXT criados em `shared/documents` para relatorios mensais.
- Rotina automatica gera mensal a cada 28 dias (mes fechado) e envia email a cada 30 dias apenas do ultimo relatorio.
- Backfill automatico gera meses antigos sem relatorio quando houver dados.
- Labels de materiais agora incluem numero/tamanho e CA para evitar duplicidade visual.
- IDs de tamanho/numero nao sao exibidos; usa nome legivel quando disponivel.
- Tooltip dos graficos de materiais mostra descricao completa, ID e quantidade.
- Botao de gerar relatorio removido do dashboard; uso passa para pagina de Relatorio de Estoque.
- Alertas ativos e materiais monitorados usam o saldo fisico acumulado (mesma base da tela Estoque atual).
- Modal de graficos expandidos agora suporta rolagem e exibe todas as linhas dos rankings (materiais, fabricantes, centros, setores e pessoas).
- Top pessoas agora exibe matricula no label quando disponivel.
- Clique em barras com ID copia o materialId para a area de transferencia.
- Chamadas a `api.estoque.report` agora incluem `X-Session-Id` para manter o guard de sessao consistente.
- Antes/Depois (sessao):
- Antes: `api.estoque.report` nao enviava `X-Session-Id`.
- Depois: `api.estoque.report` envia `X-Session-Id` para manter a sessao consistente no backend.
- Antes/Depois:
  - Antes: Paretos e interpretacoes no dashboard principal.
  - Depois: Dashboard focado em movimentacao; Paretos migrados para Analise de Estoque.
- Arquivos alterados/criados:
  - `src/pages/DashboardPage.jsx`
  - `src/hooks/useDashboardEstoque.js`
  - `src/components/charts/ParetoChart.jsx`
  - `src/utils/inventoryReportUtils.js`
  - `src/services/dashboardEstoqueApi.js`
  - `src/services/api.js`
  - `src/services/localApi.js`
  - `src/utils/dashboardEstoqueUtils.js`
  - `api/_shared/operations.js`
  - `api/index.js`
  - `api/_shared/withAuth.js`
  - `shared/documents/RELATÓRIO MENSAL DE ESTOQUE.txt`
  - `supabase/functions/relatorio-estoque-mensal-email/index.ts`
  - `supabase/migrations/20260218_add_inventory_report_email_fields.sql`
  - `supabase/migrations/20260201_create_inventory_report.sql`

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- DashboardPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/DashboardPage.jsx
  - Responsavel por: orquestrar filtros, cards, graficos e botao de relatorio.
- useDashboardEstoque
  - Tipo: hook de dados/dashboard
  - Caminho: src/hooks/useDashboardEstoque.js
  - Responsavel por: carregar dados, calcular series e rankings e disparar relatorio.
- EstoqueOperations.report/reportAuto
  - Tipo: operacao backend
  - Caminho: api/_shared/operations.js
  - Responsavel por: gerar relatorio e gravar no banco.

Constantes e configuracoes
--------------------------
- chartInfoMessagesEstoque
  - Tipo: configuracao de ajuda
  - Caminho: src/utils/dashboardEstoqueUtils.js
  - Uso: mensagens dos botoes de info dos graficos.
- DEFAULT_RISK_WEIGHTS / DEFAULT_RISK_THRESHOLDS
  - Tipo: configuracao de risco
  - Caminho: src/utils/inventoryReportUtils.js
  - Uso: peso e corte para classificacao de risco operacional.

Funcoes utilitarias relacionadas
--------------------------------
- computePercentile
  - Tipo: utilitario
  - Caminho: src/utils/inventoryReportUtils.js
  - Responsavel por: gerar percentis usados nos rankings e indicadores.
- builders de series/rankings
  - Tipo: utilitarios
  - Caminho: src/utils/dashboardEstoqueUtils.js
  - Responsavel por: formatar valores, montar series historicas e rankings.

Servicos e integracoes externas
-------------------------------
- dashboardEstoqueApi
  - Tipo: servico de API
  - Caminho: src/services/dashboardEstoqueApi.js
  - Responsavel por: buscar dashboard e gerar relatorio.
- Brevo (email)
  - Tipo: integracao externa
  - Caminho: supabase/functions/relatorio-estoque-mensal-email/_shared/relatorioEstoqueEmailCore.ts
  - Responsavel por: envio de relatorios via `BREVO_API_KEY`.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpDashboard.json (chave 'dashboard').
