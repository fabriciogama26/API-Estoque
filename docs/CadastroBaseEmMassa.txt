Cadastro Base em massa
======================

Objetivo
--------
Cadastrar itens em massa nas tabelas base (fabricantes, cargos, centros, setores) via XLSX.

Fluxo geral
-----------
1) Abrir Cadastro Base.
2) Clicar em "Importar em massa".
3) Selecionar a tabela no modal.
4) Baixar o modelo da tabela.
5) Preencher e importar a planilha XLSX.

Formato da planilha (XLSX)
--------------------------
O modelo varia por tabela, mas sempre usa texto.

Colunas obrigatorias por tabela:
- fabricantes: fabricante
- cargos: cargo
- centros_custo: centro_custo
- centros_servico: centro_servico, centro_custo
- centros_estoque: centro_estoque, centro_custo
- setores: setor, centro_servico

Colunas opcionais:
- ativo (true/false) para todas as tabelas

Regras de importacao
--------------------
- Upload bloqueado acima de VITE_IMPORTS_MAX_MB (padrao 50 MB).
- Backend bloqueia acima do limite do plano (limit_import_mb, padrao 2 MB).
- Rate limit: 1 importacao a cada 60 segundos por tenant.
- Rate limit diario: plano define limit_import_daily; 3 falhas no dia bloqueiam ate meia-noite (America/Sao_Paulo).
- Todos os valores sao texto (UUID nao e aceito).
- Nomes precisam bater com os catalogos relacionados.
- Itens duplicados na mesma planilha ou ja existentes geram erro.
- O campo ativo e opcional (default true).

Mapa do fluxo (frontend -> Supabase)
------------------------------------
UI (Modal)
- src/components/CadastroBase/CadastroBaseImportModal.jsx
  - seleciona tabela e envia arquivo XLSX

Service (frontend)
- src/services/api.js
  - api.basicRegistration.importPlanilha({ table, file })
    1) Upload no Storage (bucket "imports")
       path: cadastro-base/<tabela>/<uuid>-<arquivo>.xlsx
    2) Chama Edge Function "cadastro-base-import" com JSON:
       { "path": "<path>", "table": "<tabela>" }

Edge Functions (Supabase)
- supabase/functions/cadastro-base-import/index.ts
  - valida usuario logado e owner via JWT (Authorization Bearer) injetado pelo proxy /api/supabase (cookie HttpOnly)
  - valida e insere linhas
  - gera CSV de erros quando necessario
  - remove o XLSX enviado (best-effort)

- supabase/functions/cadastro-base-template/index.ts
  - retorna XLSX modelo por tabela

Relatorio de erros (CSV)
------------------------
Quando houver erros, a Edge Function retorna:
- errorsUrl: URL assinada para baixar o CSV
- firstError: primeira linha de erro
- errorSamples: amostras de erros
- Um resumo e amostras ficam registrados em public.api_errors.

Formato do CSV:
linha,coluna,motivo

Atualizacao 2026-03 (Seguranca)
-------------------------------
- Chamadas a Edge Functions passam pelo proxy `/api/supabase`.
- Authorization nao e montado no frontend; o backend injeta a partir do cookie HttpOnly.
