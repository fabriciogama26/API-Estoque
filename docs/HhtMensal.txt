Tela: HHT Mensal (Acidentes)
============================

Visao geral
-----------
- Registra e mantem HHT (homem-hora trabalhada) por mes e centro de servico.
- Calcula HHT final no Supabase conforme modo (manual, simples, completo).
- Mantem historico com motivo e bloqueia cancelamento quando ha acidente no mesmo centro/mes.
- Historico sem alteracoes exibe "Registro criado".
- Usa status (status_hht) para ativo/cancelado; cancelado continua visivel na lista.

Arquitetura
-----------
- Tabelas: hht_mensal, hht_mensal_hist, status_hht.
- View: hht_mensal_view (status_nome, centro_servico_nome, created/updated username).
- Funcoes/Triggers:
  - hht_mensal_apply_calcs (normaliza modo e calcula hht_calculado/hht_final).
  - hht_mensal_prevent_inactivation (bloqueia cancelamento/delete quando ha acidentes no mes/centro).
  - hht_mensal_log_update_delete (grava historico com before/after e motivo).
  - hht_mensal_delete(p_id, p_motivo) (marca cancelado e dispara historico).
- RPCs:
  - rpc_catalog_list('centros_servico') para carregar opcoes do select.
  - rpc_pessoas_count_centro para auto-preencher qtd. pessoas.
- RLS: sempre ativo; consultas filtradas por account_owner_id via RPC security definer.

Cadastro
--------
- Campos obrigatorios:
  - Mes de referencia (mes_ref).
  - Centro de servico.
  - Modo (manual, simples, completo).
  - Manual: HHT informado.
  - Simples/Completo: qtd. pessoas e horas mes base.
- Comportamento:
  - Ao trocar mes/centro, auto-preenche qtd. pessoas via peopleCount se o usuario ainda nao digitou manualmente.
  - Modo simples zera descontos/extras e fixa escala = 1 no payload.
  - Ao salvar com sucesso, limpa o form e recarrega a lista.
- Payload:
  - centroServicoId e centroServicoNome.
  - campos numericos enviados como string e normalizados no backend.

Filtros, auto-complete e listagem
---------------------------------
- Filtros:
  - Mes inicio, mes fim, centro de servico.
  - "Aplicar" chama listHhtMensal com os filtros.
  - "Limpar" restaura defaults e recarrega a lista.
- Listagem:
  - Tabela paginada (20 por pagina) com colunas Mes, Centro, Status, Modo, HHT final, Registrado por, Cadastrado em, Acoes.
  - Acoes de editar/cancelar apenas se status != Cancelado (detalhes e historico sempre disponiveis).

Boas praticas
-------------
- Manter centros_servico sem duplicidade de nome para evitar ambiguidade no select e no cruzamento com acidentes.
- Revisar status/mes/centro antes de cancelar, pois o cancelamento bloqueia edicoes futuras.

Cancelamento e saldo
--------------------
- Cancelamento solicita motivo e atualiza status para Cancelado.
- Supabase bloqueia cancelamento se houver acidente no mesmo mes/centro (mensagem aparece no modal).

Atalhos
-------
- Nao ha atalhos de URL documentados para esta tela.

Atualizacao 2026-02
-------------------
- Select de centro de servico deduplica nomes para evitar opcoes repetidas no HHT mensal.
- Botao "Atualizar" da lista padronizado com icone de refresh.
- Ao clicar em Editar na tabela, a pagina rola para o topo e mostra o formulario em modo edicao.

Atualizacao 2026-03 (Seguranca)
-------------------------------
- Lista de centros de servico agora respeita `account_owner_id` no frontend.

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- HhtMensalAcidentesPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/HhtMensalAcidentes.jsx
  - Responsavel por: estado de filtros/form, carregamento de centros, CRUD de HHT mensal, historico e modais.
  - Antes/Depois: antes nao fazia scroll ao editar; agora rola para o topo ao iniciar edicao.
- HhtMensalForm
  - Tipo: componente de UI
  - Caminho: src/components/Acidentes/HhtMensal/Form/HhtMensalForm.jsx
  - Responsavel por: formulario de cadastro/edicao, select de centro e modo.
- HhtMensalFilters
  - Tipo: componente de UI
  - Caminho: src/components/Acidentes/HhtMensal/Filters/HhtMensalFilters.jsx
  - Responsavel por: filtros (mes inicio/fim, centro) e aplicacao/limpeza.
- HhtMensalTable / HhtMensalHistoryModal / HhtMensalDetailsModal / HhtMensalDeleteModal
  - Tipo: componentes de UI
  - Caminho: src/components/Acidentes/HhtMensal/Table/* e Modal/*
  - Responsavel por: tabela, historico, detalhes e cancelamento.

Constantes e configuracoes
--------------------------
- HHT_MENSAL_FILTER_DEFAULT / HHT_MENSAL_FORM_DEFAULT / HHT_MENSAL_HISTORY_DEFAULT
  - Tipo: configuracoes
  - Caminho: src/config/HhtMensalConfig.js
  - Uso: defaults de filtros, form e modais.

Funcoes utilitarias relacionadas
--------------------------------
- buildMesRefFromMonth, computeHhtCalculado, computeHhtFinal, normalizeModo
  - Tipo: utilitarios
  - Caminho: src/utils/hhtMensalUtils.js
  - Responsavel por: normalizar mes_ref, calcular previews e validar modo.

Servicos e integracoes externas
-------------------------------
- hhtMensalService
  - Tipo: servico de API
  - Caminho: src/services/hhtMensalService.js
  - Responsavel por: list/create/update/delete/history/peopleCount via dataClient.
- listCentrosServico
  - Tipo: servico de API
  - Caminho: src/services/saidasService.js
  - Responsavel por: carregar centros de servico para selects.
- carregarCentrosServico (alterado)
  - Tipo: integracao Supabase
  - Caminho: src/services/api.js
  - Responsavel por: listar catalogo de centros_servico e deduplicar por nome.
  - Antes/Depois: antes retornava lista crua do RPC; agora remove nomes duplicados antes do select.

Ajuda contextual
----------------
- HelpButton no header abre conteudo "hhtMensal".
- Conteudo vem de src/help/helpHhtMensal.json e midias em public/help/hht-mensal.
