Ambiente de geração do Termo de EPI
===================================

Objetivo
--------
Descrever as configurações necessárias para que a pré-visualização e o download em PDF do Termo de EPI funcionem em todos os ambientes (local, homologação e produção).

Frontend (Vite)
---------------
1. Configure as variáveis no `.env.local` / `.env.production`:
   - `VITE_SUPABASE_URL` e `VITE_SUPABASE_ANON_KEY`: habilitam a consulta ao contexto do colaborador.
   - `VITE_SUPABASE_PROXY_URL` (ou `VITE_API_URL`): base do proxy `/api/supabase` usado para chamar a função de PDF sem expor token no frontend.
   - `VITE_PUBLIC_ASSETS_ORIGIN` (opcional): URL pública usada para resolver imagens e assets no HTML antes de enviar para o backend. Se não informada, o código usa `window.location.origin`/`VITE_API_URL` como fallback.【F:src/utils/TermoEpiUtils.js†L1-L94】
2. Personalize os metadados da empresa via `VITE_TERMO_EPI_EMPRESA_*` (nome, documento, endereço, contato, `logoUrl`, `logoSecundarioUrl`). O template lê esses valores ao montar o cabeçalho e dados de rodapé.【F:shared/documents/epiTermTemplate.js†L38-L120】

Função serverless (`/termo-epi`)
--------------------------------
- O repositório fornece duas opções:
  1. **Supabase Functions** (`supabase/functions/termo-epi`): basta executar `supabase functions deploy termo-epi`. Essa função aceita POST com `{ html }` ou GET com `?url=` e usa Browserless para renderizar o PDF.【F:supabase/functions/termo-epi/index.ts†L1-L160】【F:supabase/functions/termo-epi/index.ts†L215-L310】
  2. **API Vercel** (`api/documentos/termo-epi`): indicada quando preferir manter tudo na Vercel. Certifique-se de expor a função como rota HTTP pública com as mesmas variáveis abaixo.【F:api/index.js†L119-L154】

Variáveis de ambiente da função
-------------------------------
- `PUPPETEER_BROWSERLESS_IO_KEY`: chave do serviço Browserless (ou endpoint compatível). Sem ela a função retorna erro 502/402 conforme limite excedido.【F:supabase/functions/termo-epi/index.ts†L215-L276】
- `TERMO_EPI_TIMEOUT_MS` (opcional): controla o tempo limite da requisição ao Browserless. Ajuste conforme plano contratado.
- `TERMO_EPI_BROWSERLESS_URL` (opcional): endpoint alternativo caso use instância self-hosted.

Checklist de validação
----------------------
- [ ] Pré-visualização HTML carrega com dados reais (colaborador, entregas, metadados da empresa).
- [ ] Download gera PDF com imagens/estilos corretos (verificar logotipos e caracteres acentuados).
- [ ] Função serverless responde em < 10s e registra logs de erro adequados para troubleshooting.
- [ ] Variáveis de ambiente estão configuradas tanto no frontend quanto na função (Supabase/Vercel) antes do deploy.


Atualizacao 2025-11
--------------------
- Acrescentei nota sobre a necessidade de popular fabricantes e centros de servico reais no seed do ambiente, pois agora esses campos sao usados diretamente como rotulos nos graficos clicaveis do dashboard.
- Tambem detalhei que, ao testar Termos de EPI, vale reaproveitar o novo botao de expandir graficos para validar a responsividade dos componentes em resolucoes menores.
