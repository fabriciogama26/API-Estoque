Tela: Cadastro de Acidentes
===========================

- Campos com * sao obrigatorios no formulario.
Visao geral
-----------
- Registrar, editar e consultar acidentes de trabalho vinculados a pessoas cadastradas (funcionarios, estagiarios, terceiros autorizados).
- Usa catalogos de agentes, tipos de acidente, lesoes e partes lesionadas para padronizar os registros e permitir analises estatisticas.
- Mantem historico de alteracoes por acidente (quem alterou, quando e o que foi modificado).
- Possui filtros por termo livre, tipo, centro de servico, agente, lesoes, partes lesionadas e flags (SESMT / eSOCIAL).

Escopo da tela
--------------
- Registro de acidentes tipicos, de trajeto e quase-acidentes (dependendo dos tipos configurados).
- Uso principal por SESMT, CIPA, RH e liderancas com permissao de consulta.
- Fonte de dados primaria para o Dashboard de Acidentes.

Arquitetura (modular)
---------------------
- Hooks principais:
  - `useAcidentes`: carrega a lista de acidentes, controla `isLoading`, `error` e expÃµe `reload()`.
  - `useAcidenteForm`: controla estado do formulario, validacao, submit, edicao/cancelamento.
  - `useAcidenteFiltro`: guarda `filters` e aplica `filterAcidentes` gerando a lista filtrada.
  - `usePessoas`, `useAgentes`, `useLocais`, `usePartes`: carregam catÃ¡logos auxiliares de forma isolada, cada um com seu loading/erro.
- Contexto opcional:
  - `AcidentesContext` pode centralizar acidentes, filtros, funcoes de recarga e catÃ¡logos para evitar prop-drilling entre formulario, filtros, tabela e modal de historico.
- Servicos:
  - `acidentesService`: listar, criar, atualizar, carregar historico, agentes, tipos, lesoes e partes.
  - `pessoasService`: lista pessoas com matricula, nome, cargo, centro de servico e local.
- Utils:
  - `acidentesUtils`: funcoes puras como `toInputDateTime`, `parseList`, `normalizeAgenteNome`, `normalizeAgenteKey`, `extractAgenteNome` e auxiliares de filtro.
- Erros:
  - `useErrorLogger('acidentes')` registra falhas de carga, submit, filtros e historico na tabela de logs (ex.: `app_errors`).

Campos principais do formulario
-------------------------------
- Identificacao da pessoa:
  - Matricula (obrigatorio) - agora autocomplete: ao digitar matricula ou nome, abre sugestoes; ao selecionar, preenche automaticamente nome, cargo, centro de servico e local. Botao "x" limpa a selecao.
  - Nome, Cargo, Centro de servico, Setor, Local - derivados da pessoa, com possibilidade de ajuste conforme permissao.
- Dados do acidente:
  - Data/hora do acidente (obrigatorio) exibida como "Data do Acidente" e com captura de hora.
  - Dias perdidos e Dias debitados (obrigatorios quando aplicavel, armazenados como numero, exibidos como texto).
- Classificacao:
  - Classificacao Agentes: selecione um agente, escolha tipos e/ou lesoes e clique em "Incluir" para adicionar combinacoes na tabela.
  - Permite multiplos agentes; cada linha representa uma combinacao de agente + tipo + lesao.
  - Tipos e lesoes podem ter quantidades diferentes; o valor faltante fica em branco.
  - Partes lesionadas: multiseleciona uma ou mais regioes afetadas (chips removiveis).
- Campos complementares:
  - CID, CAT, Observacao, Data eSocial, flag SESMT, Data SESMT.
- Status e cancelamento:
  - Campo `ativo` controla se o acidente entra nos calculos. Cancelar apenas desativa (continua listado) e registra motivo em `cancel_motivo`.

Fluxos principais
-----------------
1) Cadastro/edicao
   - Usuario digita matricula ou nome; autocomplete exibe sugestoes e, ao selecionar, preenche dados da pessoa.
   - Preenche campos obrigatorios: matricula, data, dias perdidos/debitados, centro de servico, local, classificacao de agentes (com incluir) e partes lesionadas.
   - Campos auxiliares: CAT, observacao, CID, flags de lancamento (eSocial/SESMT).
   - Botao alterna entre "Registrar acidente" (novo) e "Salvar alteracoes" (edicao).
   - Se ja existir acidente para a mesma matricula + data, abre modal de confirmacao com o ID existente.
    - "Cancelar edicao" limpa o formulario, reseta estado de edicao e limpa caches associados se necessario.
   - HHT nao Ã© informado na ficha; o dashboard cruza data + centro com `hht_mensal`.

2) Classificacao (agentes/partes)
   - Classificacao Agentes: cada agente tem tipos/lesoes selecionados com chips; clique em "Incluir" para gravar na tabela de combinacoes.
   - Se houver mais tipos que lesoes (ou o contrario), o campo faltante fica em branco na tabela.
   - Partes lesionadas usam multiselect com chips removiveis.

3) Historico
   - Botao de relogio na tabela abre `AcidentesHistoryModal`.
   - O modal busca `acidentesService.getAcidenteHistory(id)` e exibe registros com data, usuario e campos alterados.
   - O resultado pode ser cacheado por `acidente.id` para evitar chamadas repetidas.

4) Filtros
   - Formulario de filtros controla `filters` (termo, tipo, centro de servico, agente, lesao, parte lesionada).
   - Campos de texto/select aplicam apenas ao clicar em **Aplicar** (estado de rascunho vs aplicado).
   - Checkboxes "Apenas SESMT" e "Apenas eSOCIAL" sÃ‡Ãµo aplicados imediatamente.
   - "Aplicar" usa `filterAcidentes(acidentes, filters)` para gerar a lista filtrada; "Limpar" restaura `ACIDENTES_FILTER_DEFAULT` e recarrega a lista principal, se necessario.

5) Tabela e detalhes
  - Colunas exibidas: Nome, Matricula, Data do acidente, Centro de servico, Local, CAT, CID, Registrado por, Cadastrado em.
   - Acoes: editar, historico, detalhar e cancelar (X vermelho). O botao "Detalhar" abre um modal com os demais campos (agente/tipo/lesoes/partes, dias, eSOCIAL, SESMT, observacao) e inclui o status atual.
   - Exportacao: botao "Exportar Excel (CSV)" gera planilha com acidentes filtrados.
   - Cancelar abre modal (mesmo estilo do HHT mensal) solicitando motivo; define `ativo = false`, grava `cancel_motivo` e adiciona no historico. O registro continua visivel, mas sai dos calculos/dashboard.

Cadastro em massa (novo)
------------------------
- Existe um botao "Importar em massa" ao lado de "Registrar acidente".
- A planilha exige: matricula, data, hora, dias_debitados, dias_perdidos, centro_servico, local, agentes, tipos, lesoes e partes.
  - Campos opcionais: cat, cid, observacao.
  - Agentes/tipos/lesoes/partes usam ";" como separador.
  - Upload bloqueado acima de VITE_IMPORTS_MAX_MB (padrao 50 MB).
  - Importacao calcula hash do registro; linhas ja importadas retornam "registro ja importado".
  - Se ja existir acidente para a mesma matricula e data, a linha e bloqueada.
  - O fluxo completo esta documentado em:
  - docs/AcidentesEmMassa.txt
- Relatorio de erros (CSV) agora inclui matricula por linha: linha,matricula,coluna,motivo.

Carregamento de dados
---------------------
- Pessoas, locais, agentes, tipos, lesoes e partes sao carregados em paralelo, cada catalogo com seu proprio `isLoading` e `error`.
- Catalogos de acidentes (agentes/partes/lesoes/tipos/locais) sao publicos, sem filtro por owner.
- Campo Matricula usa busca com debounce (searchPessoas quando disponivel, fallback local), exibe feedback de carregamento/erro no dropdown e so abre sugestoes quando nao ha matricula ja selecionada.
- Busca de pessoas retorna apenas ativos por padrao (includeInactive=true para sobrescrever).
- A lista principal `useAcidentes` atualiza apos:
  - Criar ou editar um acidente.
  - Acionar o botao "Atualizar".
  - Limpar filtros, se o fluxo exigir reload.

Regras e validacoes
-------------------
- `validateAcidenteForm`:
  - Garante preenchimento de campos obrigatorios.
  - Converte texto para numero em campos como dias perdidos e dias debitados.
  - Checa se os grupos obrigatorios (agentes/tipos/lesoes/partes) estao preenchidos quando configurados.
  - CAT nao pode se repetir em outro acidente do mesmo owner (validacao no front + DB).
- `createAcidentePayload` e `updateAcidentePayload`:
  - Montam o payload no formato esperado pela API/BD.
  - Mantem consistencia entre listas (`agentes`, `tipos`, `lesoes`, `partesLesionadas`) e campos unicos legados (`agente`, `tipo`, `lesao`, `parteLesionada`).
- `cancelAcidente`:
  - Define `ativo = false`, salva `cancel_motivo` e registra historico com os campos alterados.
  - Requer que a coluna `cancel_motivo` exista na tabela `acidentes` (texto/nullable).

Boas praticas
-------------
- Garantir que catalogos (agentes, tipos, lesoes, partes) estejam criados/populados antes de liberar a tela para os usuarios.
- Ordenacao de agentes/locais/partes/lesoes/tipos e alfabetica (coluna ordem removida).
- Preferir matricula como chave em imports e integracoes; nome e cargo sao derivados da tabela de pessoas.
- Usar o historico como ferramenta de auditoria, principalmente quando ha ajustes manuais de dados.
- HHT nao e campo do formulario; o dashboard cruza data + centro com `hht_mensal` ativo do mes para calcular taxas.

Atualizacao 2025-12
-------------------
- Tela refatorada para hooks, services e utils dedicados.
- UI dividida em componentes (`AcidentesForm`, `AcidentesFilters`, `AcidentesTable`, `AcidentesHistoryModal`).
- Tratamento de erros integrado com `useErrorLogger('acidentes')`.
- Botoes de acao (editar/historico) padronizados com os mesmos icones e tooltips usados em Entradas/Materiais/Pessoas.

Atualizacao 2026-01
-------------------
- Campo HHT removido da ficha; taxas agora cruzam acidentes com `hht_mensal` pelo centro e mes.
- Status exibido na lista e detalhes; botao de cancelamento segue estilo do HHT mensal, grava `ativo=false` e `cancel_motivo` e permanece visivel (nao entra nos calculos).
- Historico inclui alteracoes de status/motivo de cancelamento.
- Classificacao separada em "Classificacao Agentes" (com combinacoes por agente/tipo/lesao) e "Classificacao Partes lesionadas".
- CAT continua unico por owner; CID permite duplicidade.

Atualizacao 2026-02
-------------------
- Botao "Atualizar" da lista padronizado com icone de refresh.
- Botao "Exportar Excel (CSV)" adicionado na lista de acidentes.
- CID deixou de ser unico (CAT segue unico); RPCs e validacao do formulario ajustadas.
- Modal de confirmacao para duplicidade por matricula+data no cadastro manual.

Atualizacao 2026-03
-------------------
- Arquivos alterados:
  - supabase/migrations/20260301_fix_rpc_acidentes_import_hash.sql
  - supabase/migrations/20260302_fix_acidentes_cid_update_hash.sql
  - supabase/migrations/20260303_fix_acidentes_rehash_digest.sql
  - supabase/migrations/20260304_fix_acidentes_rehash_search_path.sql
  - src/components/Acidentes/Table/AcidentesTable.jsx
  - src/services/api.js
  - src/hooks/useAcidenteForm.js
  - src/components/Acidentes/Form/AcidentesForm.jsx
  - src/pages/Acidentes.jsx
- Funcoes tocadas:
  - public.rpc_acidentes_create_full
  - public.rpc_acidentes_update_full
  - public.rpc_acidentes_update_full_rehash
- Antes/Depois:
  - Antes havia sobrecarga sem `p_import_hash` gerando ambiguidade no RPC de edicao; depois fica apenas a assinatura com `p_import_hash`.
  - Antes o CID era validado como unico; agora CID pode repetir (CAT continua unico).
  - Antes era possivel trocar a pessoa no formulario; agora a pessoa fica bloqueada na edicao.
  - Update passou a usar RPC dedicado com recalculo de `import_hash` com os mesmos campos do cadastro/importacao.
  - Digest agora usa pgcrypto com entrada em bytea para evitar erro de assinatura.
  - search_path passou a incluir `extensions` para resolver `digest` no ambiente Supabase.
  - Coluna "Data" da tabela foi renomeada para "Data do acidente".
  - Coluna "Status" foi removida da tabela de registros.

Atualizacao 2026-01 (schema)
-----------------------------
- Arquivos alterados: supabase/migrations/20260228_register_missing_tables.sql.
- Tabelas registradas: public.acidente_partes_grupo, public.acidente_partes_sub_grupo.
- Antes/Depois: antes existiam no banco sem migration; depois estao versionadas na pasta supabase/migrations.

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- AcidentesPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/Acidentes.jsx
  - Responsavel por: orquestrar formulario, filtros, tabela e modal de historico via hooks/contexto.
- useAcidentes
  - Tipo: hook de dados
  - Caminho: src/hooks/useAcidentes.js
  - Responsavel por: listar acidentes, controlar isLoading/error e expor reload() apos salvar/editar.
- useAcidenteForm
  - Tipo: hook de formulario
  - Caminho: src/hooks/useAcidenteForm.js
  - Responsavel por: estado do form, handleFormChange, handleSubmit, startEdit, cancelEdit, resetForm; valida/payload.
- useAcidenteFiltro
  - Tipo: hook de filtros
  - Caminho: src/hooks/useAcidenteFiltro.js
  - Responsavel por: manter filters/appliedFilters, handleFilterChange/Clear/Submit e gerar acidentesFiltrados com filterAcidentes (checkboxes aplicam imediatamente).
- Componentes AcidentesForm / AcidentesFilters / AcidentesTable / AcidentesHistoryModal / AcidenteDetailsModal / AcidenteDuplicateModal
  - Tipo: componentes de UI
  - Caminho: src/components/Acidentes/*
  - Responsavel por: UI do form, filtros, tabela e modal usando props dos hooks/contexto.

Constantes e configuracoes
--------------------------
- ACIDENTES_FORM_DEFAULT, ACIDENTES_FILTER_DEFAULT, ACIDENTES_HISTORY_DEFAULT
  - Tipo: objetos de configuracao
  - Caminho: src/config/AcidentesConfig.js
  - Uso: estados iniciais de formulario, filtros e modal de historico.

Funcoes utilitarias relacionadas
--------------------------------
- validateAcidenteForm, createAcidentePayload, updateAcidentePayload, filterAcidentes, extractAgentes/Tipos/Lesoes/Partes/Centros
  - Tipo: regras/validacao/filtro
  - Caminho: src/rules/AcidentesRules.js
  - Responsavel por: validar obrigatorios, montar payloads e extrair/filtro de dados auxiliares.
  - Novo: findDuplicateAcidenteByMatriculaData detecta duplicidade por matricula+data para modal de confirmacao.
- toInputDateTime, parseList, normalizeAgenteNome/Key, extractAgenteNome e helpers de normalizacao/filtro
  - Tipo: utilitarios de dados
  - Caminho: src/utils/acidentesUtils.js
  - Responsavel por: normalizar datas/listas e nomes/keys de agentes para formularios e filtros.

Servicos e integracoes externas
-------------------------------
- acidentesService
  - Tipo: servico de API
  - Caminho: src/services/acidentesService.js
  - Responsavel por: listar/criar/atualizar acidentes, historico e catalogos (agentes/tipos/lesoes/partes).
- pessoasService
  - Tipo: servico de API
  - Caminho: src/services/pessoasService.js
  - Responsavel por: listar pessoas (matricula/nome/cargo/centro/local) usadas no formulario de acidentes.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpAcidentes.json (chave 'acidentes'); edite ali para ajustar titulos/steps/notes.
- Para imagens, salve em public/help/acidentes/ e aponte no campo 'media' do passo (ex.: /help/acidentes/exemplo.webp).
- O campo "Agente" tem um icone de informacao proprio que abre o help especifico em src/help/helpAcidentesAgentes.json (titulo, resumo, lista de agentes/tipos/lesoes).
