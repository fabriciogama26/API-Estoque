Tela: Cadastro de Acidentes

Visao geral

- Registrar, editar e consultar acidentes de trabalho vinculados a pessoas cadastradas (funcionarios, estagiarios, terceiros autorizados).

- Utiliza catalogos de agentes, tipos, lesoes e partes lesionadas para padronizar registros e permitir analises estatisticas.

- Mantem historico de alteracoes (quem alterou, quando e o que foi modificado).

- Filtros por termo livre, tipo, centro de servico e agente para localizar rapidamente registros especificos.

Escopo da tela

- Registro de acidentes tipicos, de trajeto e quase-acidentes (quando configurados nos tipos).
- Uso principal por SESMT, CIPA, RH e liderancas com permissao de consulta.
- Integra integracao logica com o Dashboard de Acidentes, que consome esses dados.

Arquitetura (modular)

Hooks de dados/estado:
- useAcidentes: carrega lista principal, controla loading/erro e expõe reload().
- useAcidenteForm: cuida do formulario (estado, validacao, submit, edicao/cancelamento).
- useAcidenteFiltro: mantem filters e aplica filterAcidentes para gerar a lista filtrada.
- usePessoas, useAgentes, useLocais, usePartes: catálogos auxiliares isolados, cada um com loading/erro proprio.

Contexto (opcional):
- AcidentesContext pode centralizar acidentes, filters, reload, setFilters e catalogos para evitar prop-drilling entre formulario, filtros, tabela e modal de historico.

Servicos:
- acidentesService: listar, criar, atualizar, historico, catalogos (agentes/tipos/lesoes/partes).
- pessoasService: listar pessoas com matricula, cargo, centro de servico, local, etc.

Utilitarios:
- src/utils/acidentesUtils.js: normalizacao, parse de listas, nomes/keys de agentes, conversoes de data/hora e funcoes de filtro.

Erros:
- Uso de useErrorLogger('acidentes') para registrar falhas de carregamento, submit, filtros e historico na tabela app_errors (Supabase).

Campos principais do formulario

Identificacao da pessoa:
- Matricula (obrigatorio). Preenche automaticamente nome, cargo, centro de servico e local.
- Nome, Cargo, Centro de servico, Setor, Local derivam da pessoa (ajustaveis conforme permissao).

Dados do acidente:
- Data/hora (obrigatorio), Dias perdidos, Dias debitados, HHT.

Classificacao:
- Agente(s), Tipo(s), Lesao(oes), Parte(s) lesionada(s) via multiselect + chips; validacao garante grupos obrigatorios preenchidos.

Complementares:
- CID, CAT, Observacao, flags eSocial/SESMT e datas correlatas.

Fluxos principais

Cadastro/edicao:
- Seleciona matricula, preenche obrigatorios, salva (novo) ou atualiza (edicao). Cancelar limpa estado e zera edicao.

Multiselecoes:
- Select + adicionar geram chips; remocao pelo chip; validacao impede submit sem grupos obrigatorios.

Historico:
- AcidentesHistoryModal chama acidentesService.getAcidenteHistory(id) e cacheia por acidente.id; mostra data/hora, usuario e campos alterados.

Filtros:
- Form de filtros controla filters; Aplicar usa filterAcidentes; Limpar restaura ACIDENTES_FILTER_DEFAULT.

Carregamento:
- Catalogos carregados em paralelo com estados proprios; useAcidentes recarrega apos salvar/editar ou via reload manual.

Regras/validacao:
- validateAcidenteForm, createAcidentePayload e updateAcidentePayload convertem campos numericos e mantem consistencia entre campos de lista e legados.

Boas praticas

- Garantir catalogos populados antes de liberar a tela.
- Preferir matricula como chave; nome/cargo sao derivados.
- Usar historico como auditoria para correcoes/importacoes.

Atualizacao 2025-12

- Tela refatorada em hooks/services/utils com componentes: AcidentesForm, AcidentesFilters, AcidentesTable, AcidentesHistoryModal.
- Logs de erro enviados para app_errors; carregamentos/filtros evitam flicker.
