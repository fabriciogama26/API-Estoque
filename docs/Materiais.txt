Tela: Materiais
===============

Visão geral
-----------
- Tela mais completa do módulo: cadastra/edita materiais de EPI, gerencia catálogos auxiliares (grupos, características, cores, numerações) e exibe histórico de preços.
- A página orquestra múltiplas requisições paralelas (`api.materiais.listDetalhado`, `groups`, `caracteristicas`, `cores`, `medidasCalcado`, `medidasVestimenta`, `fabricantes`) com tratamento individual de erros e indicadores de carregamento.【F:src/pages/Materiais.jsx†L33-L153】

Formulário
----------
- Campos principais: grupo de material (define comportamentos para calcado/vestimenta), item do catálogo, nome, fabricante, validade (dias), CA, valor unitário, descrição, centros de custo, numeração, características e cores.
- O `<MateriaisForm>` injeta `onChange={handleFormChange}` e `onSubmit={handleSubmit}`, de modo que cada alteração de campo do JSX controlado cai em `handleFormChange` antes de chegar ao estado React. Isso garante consistência enquanto o componente renderiza feedbacks de carregamento/erro e habilita/desabilita selects conforme os loaders de grupos/itens/fabricantes/tamanhos.【F:src/pages/Materiais.jsx†L640-L686】【F:src/components/Materiais/MateriaisForm.jsx†L27-L206】
- `handleFormChange` intercepta todas as mudanças de `<input>/<select>` para manter o formulário coerente antes do submit: sanitiza CA para apenas números, formata moeda, converte seleções em `{id, nome}` legíveis, sincroniza fabricante/nome do EPI e, quando o grupo muda, zera campos dependentes (lista de itens, números de calçado/vestimenta) para forçar recarga e evitar combinações inválidas.【F:src/pages/Materiais.jsx†L279-L365】
- Mudanças em `grupoMaterialId` disparam efeitos derivados: o hook `useEffect` observa o campo e chama `api.materiais.items` para carregar os EPIs do grupo, enquanto outro `useEffect` realinha o campo `nome` quando a lista assíncrona chega — ambos dependem da limpeza feita por `handleFormChange` para decidir quando resetar ou reaproveitar valores existentes.【F:src/pages/Materiais.jsx†L198-L271】
- Botões de adicionar/remover características e cores usam `normalizeSelectionList` e `findOptionByValue` para deduplicar seleções, gerar listas ordenadas e manter arrays de IDs (`caracteristicas_epi`, `coresIds`) prontos para o payload; essas funções só conseguem preservar consistência porque `handleFormChange` mantém as chaves auxiliares (`fabricanteNome`, `materialItemNome`, etc.) sincronizadas com o valor exibido.【F:src/pages/Materiais.jsx†L367-L418】【F:src/utils/selectionUtils.js†L1-L86】
- O estado inicial do formulário vem de `createMateriaisFormDefault`, e `resetForm` reutiliza essa fábrica tanto ao cancelar edição quanto após salvar/criar materiais, garantindo que futuros `handleFormChange` partam de valores conhecidos.【F:src/config/MateriaisConfig.js†L1-L27】【F:src/pages/Materiais.jsx†L439-L520】
- Ao iniciar edição (`startEdit`), o formulário é preenchido com dados normalizados do material selecionado, adicionando o item atual às opções locais para que `handleFormChange` continue reconhecendo o valor ativo mesmo antes das listas remotas carregarem; `cancelEdit` apenas delega para `resetForm` e, portanto, também refaz o estado observado por `handleFormChange`.【F:src/pages/Materiais.jsx†L522-L616】
- Botão **Salvar alterações** envia o `onSubmit` do `<form>` e dispara o fluxo de atualização descrito abaixo, após passar por `handleSubmit` (que depende dos campos já sanitizados por `handleFormChange`).【F:src/components/Materiais/MateriaisForm.jsx†L63-L216】【F:src/pages/Materiais.jsx†L439-L520】

Fluxo ao salvar alterações (edição)
-----------------------------------
1. O submit do formulário chama `handleSubmit`, que cancela o evento, limpa erros anteriores e executa `validateMaterialForm` para garantir grupo, item, fabricante, validade, valor e listas de características/cores válidas.【F:src/pages/Materiais.jsx†L473-L521】【F:src/rules/MateriaisRules.js†L163-L236】
2. Com a validação ok, `handleSubmit` resolve o nome do usuário logado (`resolveUsuarioNome`), monta o payload com `updateMaterialPayload(form, usuario)` — que sanitiza campos via `buildMaterialPayload` — e chama `api.materiais.update` passando o `id` que está em `editingMaterial`. Em seguida, o componente aguarda a promise, reseta o formulário, limpa caches de histórico e recarrega a listagem/grupos para refletir os dados atualizados.【F:src/pages/Materiais.jsx†L478-L520】【F:src/rules/MateriaisRules.js†L240-L310】
   - Esse payload já chega normalizado porque `handleFormChange` garantiu que campos de seleção tragam os IDs corretos, listas estejam deduplicadas e valores monetários/numéricos estejam prontos para validação. `updateMaterialPayload` apenas refina (merge de listas, cálculo de número específico, sanitização de CA/moeda) antes de enviar ao serviço.【F:src/pages/Materiais.jsx†L279-L418】【F:src/rules/MateriaisRules.js†L240-L310】
3. Dentro de `api.materiais.update`, o serviço busca o registro atual no Supabase, combina com o payload sanitizado e identifica campos alterados para gravar no `material_price_history` (incluindo usuário e timestamp). Depois gera o objeto final com `buildMaterialSupabasePayload`, atualiza a tabela `materiais`, sincroniza relações de cores/características (`syncMaterialRelations`) e retorna o material já atualizado da view `materiais_view`. Qualquer falha gera exceção tratada pelo formulário.【F:src/services/api.js†L1938-L2059】

Origem das colunas exibidas/gravadas
------------------------------------
- Todas as leituras usadas no formulário e no histórico partem da view `materiais_view`, tanto para carregar listas detalhadas quanto para recuperar um material antes do diff. Essa view já expõe os aliases utilizados pelo front (`materialItemNome`, `fabricanteNome`, `grupoMaterialNome`, `numeroCalcadoNome`, `numeroVestimentaNome`, entre outros), além das chaves numéricas/UUIDs correspondentes, evitando consultas manuais a cada tabela de referência.【F:supabase/migrations/20240214130000_create_materiais_view.sql†L1-L120】【F:src/services/api.js†L1847-L2059】
- `mapMaterialRecord` traduz o resultado dessa view para o formato consumido pelo React, preservando tanto os IDs quanto os rótulos legíveis que `handleFormChange` e `updateMaterialPayload` esperam. Dessa forma, o fluxo mantém consistência entre o que é exibido na tela e o que é persistido ao salvar alterações.【F:src/services/api.js†L1751-L1844】【F:src/pages/Materiais.jsx†L279-L521】

Listagem e filtros
------------------
- `MateriaisFilters` permite filtrar por termo, grupo, fabricante, validade mínima/máxima e status de estoque. Os filtros alimentam `filterMateriais`/`sortMateriaisByNome` antes de repassar para a tabela.【F:src/pages/Materiais.jsx†L523-L603】
- A tabela mostra ações de editar e histórico. O botão **Atualizar** refaz a consulta no Supabase/local API mantendo a ordenação alfabética.【F:src/pages/Materiais.jsx†L605-L640】

Histórico de preços
-------------------
- Ao abrir o modal de histórico, a página consulta `api.materiais.history(material.id)` apenas uma vez e armazena em `historyCache`; chamadas subsequentes reutilizam o cache local para evitar requisições redundantes.【F:src/pages/Materiais.jsx†L57-L75】【F:src/pages/Materiais.jsx†L457-L520】
- `MateriaisHistoryModal` recebe o estado `historyModal` com bandeiras de carregamento/erro e exibe a linha do tempo de alterações.

Boas práticas
-------------
- Popule as tabelas de referência (grupos, características, cores, medidas) antes de abrir a tela em produção para evitar formulários vazios.
- Ao adicionar novos campos no Supabase, atualize `createMateriaisFormDefault`, `MateriaisForm` e `createMaterialPayload`/`updateMaterialPayload` em `src/rules/MateriaisRules.js` para manter coerência.
- Use o histórico para auditar alterações manuais feitas via Studio ou integrações externas.
