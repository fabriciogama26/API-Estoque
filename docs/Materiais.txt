Tela: Cadastro de Materiais (EPI)
- Conteudo em src/help/helpMateriais.json; edite titulos/steps/notes e midias (/public/help/materiais/*).
- Campos com * sao obrigatorios no formulario.

Visão geral

Cadastro e manutenção de materiais/EPI com fabricantes, grupos, cores, características, histórico de preços e histórico de edições. Suporta modo Supabase e local.

Arquitetura (modular)

- Hooks: useMateriaisController (form, filtros, lista, paginação, histórico), catálogos (grupos/itens/fabricantes/cores/características/medidas).
- Serviços: materiaisService (listar/criar/atualizar, detalhes completos, histórico de preço), dataMode remoto/local.
- Utils: MateriaisUtils (formatação/moeda, normalização de selects), selectionUtils; regras em MateriaisRules (payloads, validações, filtro).
- Erros: useErrorLogger('materiais') envia falhas para app_errors.

Fluxos principais

- Formulário: dados básicos (item/grupo/fabricante), medidas (calçado/vestimenta), CA, validade, valor unitário, estoque mínimo, ativo; prevenção de duplicidade via preflight + gatilhos.
- Lista: colunas Grupo, Material, Descrição, Valor unitário, Validade (dias), Fabricante, Registrado por, Cadastrado em; ações Ver (detalhes em cartões), Editar, Histórico.
- Filtros: termo livre, grupo, tamanho/número, fabricante, características, cores, status e intervalo de valor unitário (mín/máx); ajuste os campos e clique em Aplicar para recalcular (sem refiltro automático); limpar restaura defaults.
- Detalhes: modal em cartões (padrão acidentes) com todos os campos, buscando o material completo por id.
- Histórico: modal no padrão “Histórico do acidente”, exibindo edições campo a campo (usuário/data).

Boas práticas

- Sempre usar formatadores de moeda (MateriaisUtils); validar números antes do submit.
- Priorizar consultas com projeção mínima na lista e buscar detalhes completos sob demanda.
- Respeitar mensagens de duplicidade do gatilho; ajustar catálogos antes de forçar inserts.

Atualizações recentes

- 2025-12: Lista reordenada, filtro de valor unitário adicionado, detalhes/histórico padronizados, datas de cadastro mapeadas, botão de olho para detalhes.
- 2026-01: Preflight `material_preflight_check` compara base completa (fabricante+grupo+item+número+cores+características) e retorna: `ca_conflict` (bloqueia), `base_conflict_empty` (bloqueia) e `base_match_ca_diff` (alerta/modal). Em update o próprio id é ignorado (`p_material_id`). Os gatilhos de INSERT/UPDATE usam os hashes `hash_base`/`hash_completo` para impedir base igual com CA vazio ou CA repetido na mesma base.
- 2026-01: RPCs material_create_full e material_update_full gravam material + vinculos (cores/caracteristicas) em uma unica transacao; evita 42501 em RLS de tabelas de vinculo.
- 2026-01: Migrations registram tabelas de catalogo e vinculos de materiais (cores/caracteristicas/medidas/fabricantes/epi_classe) e coluna created_at nos vinculos.

===========================================
Mapa de Código (funções, hooks e constantes)
===========================================

Funções principais
------------------
- MateriaisPage — componente de página (src/pages/Materiais.jsx); orquestra formulário, filtros, tabela, detalhes e histórico via MateriaisProvider.
- useMateriaisController — hook/controller (src/hooks/useMateriaisController.js); estado do form, filtros, lista, histórico de preço, submit/editar, catálogos.
- MateriaisProvider / MateriaisContext — contexto (src/context/MateriaisContext.jsx); expõe dados/handlers para form/filtros/tabela/modais.
- Componentes MateriaisForm/Filters/Table/HistoryModal — UI do cadastro, filtros, tabela e históricos.

Constantes e configurações
--------------------------
- createMateriaisFormDefault, MATERIAIS_FILTER_DEFAULT, HISTORY_MODAL_DEFAULT — src/config/MateriaisConfig.js; estados iniciais de formulário, filtros e modal de histórico.

Funções utilitárias relacionadas
--------------------------------
- validateMaterialForm, create/updateMaterialPayload, filterMateriais (inclui faixa de valor), parseCaracteristicaEpi, sortMateriaisByNome — src/rules/MateriaisRules.js.
- formatCurrency/formatCurrencyInput, findOptionByValue, normalizeSelectionList/Item/Key, selectionToArray — src/utils/MateriaisUtils.js e src/utils/selectionUtils.js.

Serviços e integrações externas
-------------------------------
- materiaisService — serviço de API (src/services/materiaisService.js); listar/criar/atualizar, detalhes completos (get), histórico de preço, catálogos (grupos, itens, fabricantes, cores, características, calçados, tamanhos).

Ajuda contextual
----------------
- Botão 'Ajuda' no cabeçalho abre modal com passos/notas desta página.
- Conteudo em src/help/helpMateriais.json; edite titulos/steps/notes e midias (/public/help/materiais/*).


Atualizacao 2026-01 (UI)
- Modais dedicados: src/components/Materiais/Modal/MaterialBaseDiffModal.jsx e src/components/Materiais/Modal/MaterialDetailsModal.jsx.

Atualizacao 2026-01 (schema)
- Arquivos alterados: supabase/migrations/20260228_register_missing_tables.sql.
- Tabelas registradas: public.material_grupo_cor, public.material_grupo_caracteristica_epi, public.cor, public.caracteristica_epi, public.fabricantes, public.medidas_calcado, public.medidas_vestimentas, public.epi_classe.
- Colunas registradas: public.material_grupo_cor.created_at, public.material_grupo_caracteristica_epi.created_at.
- Antes/Depois: antes existiam no banco sem migration; depois estao versionadas na pasta supabase/migrations.
