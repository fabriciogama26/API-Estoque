Tela: Materiais
===============

Visão geral
-----------
- Tela mais completa do módulo: cadastra/edita materiais de EPI, gerencia catálogos auxiliares (grupos, características, cores, numerações) e exibe histórico de preços.
- A página orquestra múltiplas requisições paralelas (`api.materiais.listDetalhado`, `groups`, `caracteristicas`, `cores`, `medidasCalcado`, `medidasVestimenta`, `fabricantes`) com tratamento individual de erros e indicadores de carregamento.【F:src/pages/Materiais.jsx†L33-L153】

Formulário
----------
- Campos principais: grupo de material (define comportamentos para calcado/vestimenta), item do catálogo, nome, fabricante, validade (dias), CA, valor unitário, descrição, centros de custo, numeração, características e cores.
- `handleFormChange` normaliza valores (remove não dígitos do CA, formata moeda, propaga centro de serviço) e garante consistência ao trocar o grupo (limpa nome/números incompatíveis).【F:src/pages/Materiais.jsx†L154-L286】
- Botões de adicionar/remover características e cores trabalham com listas normalizadas (`normalizeSelectionList`) para evitar duplicidades e manter referência aos IDs quando disponíveis.【F:src/pages/Materiais.jsx†L288-L414】
- Ao iniciar edição (`startEdit`) o formulário é preenchido com dados existentes, mantendo caches locais de grupos/itens/fabricantes para facilitar reuso; `cancelEdit` restaura o estado inicial.【F:src/pages/Materiais.jsx†L418-L521】

Listagem e filtros
------------------
- `MateriaisFilters` permite filtrar por termo, grupo, fabricante, validade mínima/máxima e status de estoque. Os filtros alimentam `filterMateriais`/`sortMateriaisByNome` antes de repassar para a tabela.【F:src/pages/Materiais.jsx†L523-L603】
- A tabela mostra ações de editar e histórico. O botão **Atualizar** refaz a consulta no Supabase/local API mantendo a ordenação alfabética.【F:src/pages/Materiais.jsx†L605-L640】

Histórico de preços
-------------------
- Ao abrir o modal de histórico, a página consulta `api.materiais.history(material.id)` apenas uma vez e armazena em `historyCache`; chamadas subsequentes reutilizam o cache local para evitar requisições redundantes.【F:src/pages/Materiais.jsx†L57-L75】【F:src/pages/Materiais.jsx†L457-L520】
- `MateriaisHistoryModal` recebe o estado `historyModal` com bandeiras de carregamento/erro e exibe a linha do tempo de alterações.

Boas práticas
-------------
- Popule as tabelas de referência (grupos, características, cores, medidas) antes de abrir a tela em produção para evitar formulários vazios.
- Ao adicionar novos campos no Supabase, atualize `createMateriaisFormDefault`, `MateriaisForm` e `createMaterialPayload`/`updateMaterialPayload` em `src/rules/MateriaisRules.js` para manter coerência.
- Use o histórico para auditar alterações manuais feitas via Studio ou integrações externas.
