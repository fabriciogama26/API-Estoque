Tela: Saidas de Materiais
==============

Visao geral
-----------
- Registra, edita, consulta e cancela saidas de EPI/materiais.
- Suporta consulta com filtros por periodo, centros, status, prazo de troca, registrado por e termo livre.
- Caminhos suportados: /saidas e /movimentacoes/saidas.
- Campos com * sao obrigatorios no formulario.

Arquitetura
-----------
- Contexto:
  - `SaidasProvider` (`SaidasContext`) expoe estado e acoes do hook `useSaidasController`.
- Hook `useSaidasController`:
  - Centraliza estado de formulario, filtros, lista e paginacao.
  - Implementa handlers de submit, edicao, cancelamento, historico e troca.
  - Faz integracao com logs via `useErrorLogger('saidas')`.
- Utils:
  - `saidasUtils` cuida de normalizacao, formatacao e montagem de query.
- Servicos:
  - `saidasService` concentra list/create/update/cancel e history (dataMode remoto/local).
- Erros/RLS:
  - Trigger `trg_set_data_troca` depende de `materiais`; precisa rodar como definer com row_security off para nao bloquear insert.
  - FKs referenciam status_saida, centros, materiais e pessoas; requer SELECT liberado para evitar 42501 em inserts/updates.

Cadastro
--------
- Campos obrigatorios:
  - Pessoa (autocomplete).
  - Centro de estoque (habilita busca de material).
  - Material (autocomplete por nome/ID/descricao/CA).
  - Quantidade (>0).
  - Data da entrega.
- Campos derivados:
  - Centro de custo e centro de servico preenchidos pela pessoa.
  - Campo "Em estoque" somente leitura.
- Comportamento:
  - Ao editar, rola para o topo e habilita "Cancelar edicao".
  - Bloqueia registro quando saldo do material <= 0 ou quando a quantidade informada supera o saldo disponivel.
  - Erros aparecem em area de feedback.

Filtros, auto-complete e listagem
---------------------------------
- Filtros:
  - Termo livre (pessoa/material).
  - Registrado por (usuario).
  - Status, prazo de troca, data inicial/final e "Apenas trocas".
  - "Aplicar" chama `load(filters)`; "Limpar" restaura defaults e recarrega.
  - Termo, status e registrado por aplicam refiltro local com normalizacao (fallback quando a API nao filtra).
- Registrado por:
  - Usa `usuarioResponsavelId` quando disponivel; fallback por nome quando nao ha ID.
- Auto-complete de materiais:
  - Dispara busca apos `MATERIAL_SEARCH_MIN_CHARS` com debounce.
  - Fallback local quando `api.materiais.search` nao existe.
  - Lista apenas materiais com saldo > 0 no centro de estoque selecionado.
- Auto-complete de pessoas:
  - Dispara busca apos `PESSOA_SEARCH_MIN_CHARS` com debounce.
- Tabela:
  - Colunas Pessoa, Material, Quantidade, Data entrega, Status, Registrado por, Cadastrado em.
  - Acoes Ver, Editar, Historico, Cancelar.
- Exportacao:
  - Botao "Exportar Excel (CSV)" gera planilha com todas as saidas filtradas.
  - Material exporta o resumo completo (ex.: "Calca | Vestimentas | XG | AMARELA | PVC | BRASCAMP").
  - Centro de estoque exporta o nome resolvido quando disponivel.
- Detalhes e historico:
  - Modais dedicados no padrao de acidentes.
  - Quando nao ha alteracoes, o item exibe "Registro criado".

Boas praticas
-------------
- Evitar recarga quando filtros nao mudam; loaders locais.
- Exigir motivo no cancelamento e manter log/historico.

Cancelamento e saldo
--------------------
- Cancelamento exige motivo e registra historico de saida.
- Registros sensiveis devem gerar auditoria (historico/saida_historico).

Atalhos
-------
- A tela pode ser aberta com parametros para pre-preencher o formulario:
  - `?centroEstoque=<nome-ou-id>`
  - `?materialId=<id-do-material>`
- Primeiro seleciona o centro e depois tenta selecionar o material.

Atualizacao 2025-12
-------------------
- Tela modularizada com hooks/services/utils; detalhes e historico padronizados; status dinamico.
- Campo "Em estoque" destacado e sem linha extra de saldo/min/valor.

Atualizacao 2026-01
-------------------
- Filtro "Registrado por" passa a enviar ID quando disponivel e compara por nome em fallback.
- Busca por termo aplica refiltro local com normalizacao para pessoa/material.
- Filtro registradoPor aplicado no dataMode local e na API serverless.
- Filtro de status aplica refiltro local com normalizacao.
- Exportacao CSV com base na lista filtrada da tela.
- Bloqueio adicional no formulario quando saldo do material <= 0 ou quantidade > saldo.

Atualizacao 2026-02
-------------------
- Botao "Atualizar" da lista padronizado com icone de refresh.

Atualizacao 2026-01 (estoque)
-----------------------------
- Arquivos alterados:
  - src/hooks/useSaidasController.js
  - src/help/helpSaidas.json
  - docs/Saidas.txt
  - src/services/saidasService.js
- Funcoes/hooks tocadas:
  - useSaidasController.handleSubmit (validacao de saldo)
  - useSaidasController.confirmTroca (validacao de saldo)
  - useSaidasController (filtro de materiais com saldo > 0 no autocomplete)
  - saidasService.getMaterialEstoque (usa materiais.estoqueAtual quando disponivel)
- Comportamento antes/depois:
  - Antes: validacao de saldo apenas via backend (Supabase/RPC).
  - Depois: UI bloqueia saida quando saldo <= 0 ou quando a quantidade excede o saldo (inclui edicao).
  - Antes: autocomplete podia listar materiais com saldo zero/negativo.
  - Depois: autocomplete lista apenas materiais com saldo positivo no centro selecionado.

Atualizacao 2026-01 (schema)
-----------------------------
- Arquivos alterados: supabase/migrations/20260228_register_missing_tables.sql.
- Tabelas registradas: public.status_saida, public.centros_estoque.
- Antes/Depois: antes existiam no banco sem migration; depois estao versionadas na pasta supabase/migrations.

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- SaidasPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/SaidasPage.jsx
  - Responsavel por: orquestrar formulario, filtros e tabela via contexto/controller.
- useSaidasController
  - Tipo: hook/controller
  - Caminho: src/hooks/useSaidasController.js
  - Responsavel por: estado do form, filtros, lista, paginacao, submit/editar/cancelar e historico.
- SaidasContext
  - Tipo: contexto
  - Caminho: src/context/SaidasContext.jsx
  - Responsavel por: compartilhar estado/handlers do controller com os componentes.
- Componentes de UI
  - Tipo: componentes
  - Caminho: src/components/Saidas/* e src/components/Saidas/Modal/*
  - Responsavel por: UI de formulario, filtros, tabela, detalhes, historico e cancelamento.

Constantes e configuracoes
--------------------------
- Defaults de formulario/filtro/historico
  - Tipo: constantes
  - Caminho: src/utils/saidasUtils.js (initialSaidaForm/initialSaidaFilters)
  - Uso: estados iniciais de formulario e filtros.

Funcoes utilitarias relacionadas
--------------------------------
- Normalizacao e formatadores
  - Tipo: utilitarios
  - Caminho: src/utils/saidasUtils.js
  - Responsavel por: normalizar busca, formatar dados e montar query.
- Exportacao CSV
  - Tipo: utilitarios
  - Caminho: src/utils/saidasExport.js
  - Responsavel por: gerar e baixar CSV com as saidas filtradas.

Servicos e integracoes externas
-------------------------------
- saidasService
  - Tipo: servico de API
  - Caminho: src/services/saidasService.js
  - Responsavel por: listar/criar/atualizar/cancelar saidas (Supabase ou dataClient local).
- SaidasOperations.list (API serverless)
  - Tipo: handler backend
  - Caminho: api/_shared/operations.js
  - Responsavel por: listar saidas com filtros (inclui registradoPor).
- localApi.saidas.list / filterLocalSaidas
  - Tipo: servico local
  - Caminho: src/services/localApi.js
  - Responsavel por: filtrar saidas no modo local (termo/registrado por).

Ajuda contextual
----------------
- Botao "Ajuda" no cabecalho abre modal com passos e notas desta pagina.
- Conteudo em src/help/helpSaidas.json; midias em /public/help/saidas/*.
