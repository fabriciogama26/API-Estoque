Tela: Relatorio de Estoque
=========================

Visao geral
-----------
- Permite consultar o historico de relatorios mensais gravados em inventory_report.
- Gera o HTML do relatorio no frontend a partir dos dados persistidos para pre-visualizacao.
- O PDF e gerado separadamente, sem consumir o limite na pre-visualizacao.
- Relatorios mensais sao gerados automaticamente por Edge Functions e enviados por email HTML somente para o ultimo mes gerado.
- Respeita limite de 1 PDF por mes por relatorio.
- Ranking de consumo por centro/setor considera quantidade e valor, com top 10 e percentuais.
- Desvios por centro/setor sao marcados por concentracao >= 30% ou outlier (media + 2 desvios).
- Cobertura por trabalhador usa consumo medio mensal por centro/setor e status por faixas (CRITICO < 0,5; ATENCAO 0,5 a 1,0; OK >= 1,0; SEM BASE sem pessoas ou consumo).
- Pessoas sao carregadas da tabela `pessoas` e enriquecidas com centro/setor/centro de custo via joins nas tabelas de apoio.
- Colaboradores inativos com movimentacao no periodo entram no calculo.

Arquitetura
-----------
- Pagina `RelatorioEstoquePage` consome hook `useRelatorioEstoque`.
- Hook chama `relatorioEstoqueApi` para listar relatorios, carregar contexto e gerar PDF.
- Backend exposto em `EstoqueOperations.reportHistory`, `EstoqueOperations.reportHtml` (contexto) e `EstoqueOperations.reportPdf`.
- Edge Function `relatorio-estoque-mensal` gera os dados e grava em `inventory_report`.
- Edge Function `relatorio-estoque-mensal-email` gera HTML a partir do historico e envia email HTML.
- Edge Function `relatorio-estoque-mensal` grava logs de execucao em `edge_functions_error_report` (bucket `cron`).
- Core da geracao automatica fica em `supabase/functions/relatorio-estoque-mensal/_shared/relatorioEstoqueCore.ts`.
- Persistencia feita na tabela `inventory_report` (campos pdf_gerado_em/pdf_gerado_por/email_status/email_enviado_em/email_erro/email_tentativas).

Filtros, auto-complete e listagem
---------------------------------
- Mensal: filtra por mes (YYYY-MM).
- Listagem mostra: criado por, criado em, periodo inicio, periodo fim e status de email.
- Buscar carrega a pre-visualizacao do mes informado usando o template no frontend.
- Botao "Gerar PDF" fica desabilitado quando o limite mensal foi atingido.

Boas praticas
-------------
- Executar o cron de geracao a cada 28 dias (ex.: `0 3 */28 * *`) para gerar o ultimo mes fechado.
- Executar o cron de email a cada 30 dias (ex.: `0 4 */30 * *`) para enviar somente o ultimo relatorio gerado.
- Cron configurado no pg_cron em 2026-02-19 (jobs relatorio-estoque-mensal e relatorio-estoque-mensal-email).
- Usar apenas dados salvos em inventory_report para gerar HTML/PDF.
- Manter PDF_REPORT_LIMIT_PER_MONTH em `src/config/RelatorioEstoqueConfig.js`.
- Revisar centros com desvio e ajustar estoque minimo quando houver concentracao.

Atualizacao 2026-02
-------------------
- Relatorios trimestrais removidos; fluxo passa a ser apenas mensal.
- Edge Function mensal gera dados e grava em inventory_report.
- Edge Function de email mensal envia HTML via Brevo usando dados persistidos.
- Execucoes dos crons `relatorio-estoque-mensal` e `relatorio-estoque-mensal-email` agora registram resumo em `edge_functions_error_report`.
- Endpoints mantidos para listar relatorios e fornecer contexto/PDF a partir do historico.
- Pre-visualizacao passou a ser carregada com contexto do backend e template no frontend, sem consumir o limite de PDF.
- Limite de 1 PDF por mes por relatorio com registro em inventory_report.
- Campos de controle de email adicionados em inventory_report (status, tentativas e erro).
- PDF passou a ser renderizado pela Edge Function dedicada `relatorio-estoque-pdf`.
- Ranking de consumo por centro/setor passou a usar quantidade e valor (top 10 com percentuais).
- Desvio por centro/setor aplica regra de concentracao (>= 30%) e outlier (media + 2 desvios).
- Cobertura por trabalhador agora considera consumo medio mensal por centro/setor e classifica status (OK/ATENCAO/CRITICO/SEM BASE).
- Arquivos alterados:
- `src/pages/RelatorioEstoque.jsx`
- `src/hooks/useRelatorioEstoque.js`
- `src/services/relatorioEstoqueApi.js`
- `src/services/api.js`
- `src/services/localApi.js`
- `src/utils/RelatorioEstoquePdfUtils.js`
- `src/utils/inventoryReportUtils.js`
- `src/lib/estoque.js`
- `src/help/helpRelatorioEstoque.json`
- `api/_shared/operations.js`
- `api/index.js`
- `shared/documents/relatorioEstoqueTemplate.js`
- `supabase/functions/relatorio-estoque-mensal/index.ts`
- `supabase/functions/relatorio-estoque-mensal-email/index.ts`
- `supabase/functions/relatorio-estoque-mensal/_shared/relatorioEstoqueCore.ts`
- `supabase/functions/relatorio-estoque-mensal-email/_shared/relatorioEstoqueEmailCore.ts`
- `supabase/migrations/20260218_add_inventory_report_email_fields.sql`
- `supabase/functions/relatorio-estoque-pdf/index.ts`
- Antes/Depois:
- Antes: os crons de relatorio nao registravam execucao em `edge_functions_error_report`.
- Depois: os crons de relatorio registram resumo da execucao em `edge_functions_error_report`.

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- RelatorioEstoquePage
  - Tipo: componente de pagina React
  - Caminho: src/pages/RelatorioEstoque.jsx
  - Responsavel por: filtros, listagem e pre-visualizacao do relatorio.
- useRelatorioEstoque
  - Tipo: hook
  - Caminho: src/hooks/useRelatorioEstoque.js
  - Responsavel por: carregar historico, acionar geracao de PDF e tratar limites.
- EstoqueOperations.reportHistory / reportHtml / reportPdf
  - Tipo: operacoes backend
  - Caminho: api/_shared/operations.js
  - Responsavel por: listar relatorios, fornecer contexto e registrar geracao de PDF.
- relatorio-estoque-mensal / relatorio-estoque-mensal-email
  - Tipo: edge functions
  - Caminho: supabase/functions/relatorio-estoque-mensal/index.ts
  - Caminho: supabase/functions/relatorio-estoque-mensal-email/index.ts
  - Responsavel por: gerar dados mensais, enviar email HTML e registrar execucoes em edge_functions_error_report.
- relatorioEstoqueCore
  - Tipo: utilitario de edge function
  - Caminho: supabase/functions/relatorio-estoque-mensal/_shared/relatorioEstoqueCore.ts
  - Responsavel por: montar dados e persistir em inventory_report.
  - Calcula ranking de consumo, desvios e cobertura por centro/setor.

Constantes e configuracoes
--------------------------
- PDF_REPORT_LIMIT_PER_MONTH
  - Tipo: configuracao
  - Caminho: src/config/RelatorioEstoqueConfig.js
  - Uso: limite mensal de geracao de PDF por relatorio.

Funcoes utilitarias relacionadas
--------------------------------
- downloadRelatorioEstoquePdf
  - Tipo: utilitario
  - Caminho: src/utils/RelatorioEstoquePdfUtils.js
  - Responsavel por: enviar HTML para renderizacao e baixar PDF.

Servicos e integracoes externas
-------------------------------
- relatorioEstoqueApi
  - Tipo: servico
  - Caminho: src/services/relatorioEstoqueApi.js
  - Responsavel por: listar relatorios e solicitar contexto/PDF.
- Supabase Functions (renderizacao PDF)
  - Tipo: integracao externa
  - Caminho: supabase/functions/relatorio-estoque-pdf
  - Responsavel por: converter HTML em PDF.
- Brevo (email HTML)
  - Tipo: integracao externa
  - Caminho: supabase/functions/relatorio-estoque-mensal-email/_shared/relatorioEstoqueEmailCore.ts
  - Responsavel por: envio de relatorios mensais.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpRelatorioEstoque.json.
- `supabase/functions/relatorio-estoque-pdf/index.ts`
