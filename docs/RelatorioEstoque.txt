Tela: Relatorio de Estoque
=========================

Visao geral
-----------
- Permite consultar o historico de relatorios mensais gravados em inventory_report.
- Gera o HTML do relatorio no frontend a partir dos dados persistidos para pre-visualizacao.
- O PDF e gerado separadamente, sem consumir o limite na pre-visualizacao.
- A renderizacao de PDF via Edge Function `relatorio-estoque-pdf` exige Authorization Bearer JWT.
- Relatorios mensais sao gerados automaticamente por Edge Functions e enviados por email HTML somente para o ultimo mes gerado.
- Relatorios semanais sao gerados com CSVs (estoque atual, entradas, saidas, acidentes e HHT) e enviados por email com anexos.
- Periodo semanal considera os ultimos 7 dias a partir do horario de execucao.
- Respeita limite de 1 PDF por mes por relatorio.
- Ranking de consumo por centro/setor considera quantidade e valor, com top 10 e percentuais.
- Desvios por centro/setor sao marcados por concentracao >= 30% ou outlier (media + 2 desvios).
- Cobertura por trabalhador usa consumo medio mensal por centro/setor e status por faixas (CRITICO < 0,5; ATENCAO 0,5 a 1,0; OK >= 1,0; SEM BASE sem pessoas ou consumo).
- Pessoas sao carregadas da tabela `pessoas` e enriquecidas com centro/setor/centro de custo via joins nas tabelas de apoio.
- Colaboradores inativos com movimentacao no periodo entram no calculo.
- Identificacao do nivel (CRITICO/ATENCAO/OK) aparece no resumo executivo do HTML/PDF.

Arquitetura
-----------
- Pagina `RelatorioEstoquePage` consome hook `useRelatorioEstoque`.
- Hook chama `relatorioEstoqueApi` para listar relatorios, carregar contexto e gerar PDF.
- Backend exposto em `EstoqueOperations.reportHistory`, `EstoqueOperations.reportHtml` (contexto) e `EstoqueOperations.reportPdf`.
- Edge Function `relatorio-estoque-mensal` gera os dados e grava em `inventory_report`.
- Edge Function `relatorio-estoque-mensal-email` gera HTML a partir do historico e envia email HTML.
- Edge Functions `relatorio-estoque-semanal` e `relatorio-estoque-semanal-email` geram CSVs semanais e enviam email com anexos.
- Edge Function `relatorio-estoque-mensal` grava logs de execucao em `edge_functions_error_report` (bucket `cron`).
- Core da geracao automatica fica em `supabase/functions/relatorio-estoque-mensal/_shared/relatorioEstoqueCore.ts`.
- Persistencia feita na tabela `inventory_report` (campos pdf_gerado_em/pdf_gerado_por/email_status/email_enviado_em/email_erro/email_tentativas).

Filtros, auto-complete e listagem
---------------------------------
- Mensal: filtra por mes (YYYY-MM).
- Listagem mostra: criado por, criado em, periodo inicio, periodo fim e status de email.
- Buscar carrega a pre-visualizacao do mes informado usando o template no frontend.
- Botao "Gerar PDF" fica desabilitado quando o limite mensal foi atingido.

Boas praticas
-------------
- Executar o cron de geracao a cada 28 dias (ex.: `0 3 */28 * *`) para gerar o ultimo mes fechado.
- Executar o cron de email a cada 30 dias (ex.: `0 4 */30 * *`) para enviar somente o ultimo relatorio gerado.
- Executar o cron semanal em sexta-feira as 18:10 (America/Sao_Paulo). No pg_cron (UTC), usar 21:10.
- Cron configurado no pg_cron em 2026-02-19 (jobs relatorio-estoque-mensal e relatorio-estoque-mensal-email).
- CSVs semanais ficam no bucket `imports` em `<owner_id>/relatorios-semanais/<periodo>/` e sao limpos pelo cron de cleanup.
- Usar apenas dados salvos em inventory_report para gerar HTML/PDF.
- Manter PDF_REPORT_LIMIT_PER_MONTH em `src/config/RelatorioEstoqueConfig.js`.
- Revisar centros com desvio e ajustar estoque minimo quando houver concentracao.
- Para teste manual de email, enviar `test_email` (body/query/header) e opcionalmente `test_owner_id`. Em modo teste nao atualiza status do email.
- Remetente do email mensal vem de `RELATORIO_ESTOQUE_EMAIL_FROM` (verificado na Brevo).
- Template do email mensal exibe logo principal (termo EPI) a esquerda com tamanho maior e logo secundaria (login) a direita com tamanho menor, alem do aviso de email automatico.
- Pre-visualizacao usa apenas a logo principal do termo EPI.
- Busca de administradores para envio considera `credential` como texto (admin/master) ou UUID referenciando `app_credentials_catalog`.

Atualizacao 2026-02
-------------------
- Relatorios trimestrais removidos; fluxo passa a ser apenas mensal.
- Edge Function mensal gera dados e grava em inventory_report.
- Edge Function de email mensal envia HTML via Brevo usando dados persistidos.
- Execucoes dos crons `relatorio-estoque-mensal` e `relatorio-estoque-mensal-email` agora registram resumo em `edge_functions_error_report`.
- Endpoints mantidos para listar relatorios e fornecer contexto/PDF a partir do historico.
- Pre-visualizacao passou a ser carregada com contexto do backend e template no frontend, sem consumir o limite de PDF.
- Limite de 1 PDF por mes por relatorio com registro em inventory_report.
- Campos de controle de email adicionados em inventory_report (status, tentativas e erro).
- PDF passou a ser renderizado pela Edge Function dedicada `relatorio-estoque-pdf`.
- `relatorio-estoque-pdf` passou a exigir Authorization Bearer JWT; o frontend envia o token de sessao.
- Edge Function de email mensal aceita `test_email` para envio de teste sem atualizar status.
- Remetente do email mensal passou a usar `RELATORIO_ESTOQUE_EMAIL_FROM`.
- Header do email mensal passou a incluir duas logos e aviso de email automatico.
- Pre-visualizacao HTML passou a ser sanitizada e exibida em iframe sandbox.
- Modo trusted (templates internos) usa allow-same-origin para auto-resize; modo untrusted usa sandbox vazio com scroll.
- Sanitizacao preserva documento completo e estilos (head/style/class/id) para manter o layout da pre-visualizacao.
- Sanitizacao registra eventos de seguranca (script, event_handler, javascript_url, iframe) em app_errors com tenant_hint quando ha remocao.
- Edge Function relatorio-estoque-pdf registra eventos de seguranca (api_errors) quando HTML suspeito e enviado.
- Preview envia contexto (page/tenant_hint/user_id) para log de seguranca.
- Rate limit: edge function `relatorio-estoque-pdf` limita 1 requisicao por tenant a cada 60 segundos (tabela edge_rate_limits).
- Rate limit diario: plano define limite de PDF (limit_pdf_daily). Conta apenas sucesso; 3 falhas no dia bloqueiam ate meia-noite (America/Sao_Paulo).
- Observabilidade: falhas nos RPCs diarios (`edge_rate_limit_daily_check` / `edge_rate_limit_daily_register`) geram log em `api_errors` com code DAILY_LIMIT_*.
- Reset manual (teste): limpar consumo diario do tenant atual:
```
delete from public.edge_rate_limits_daily
where account_owner_id = '<OWNER_ID>'
  and day_date = (now() at time zone 'America/Sao_Paulo')::date;
```
- Ranking de consumo por centro/setor passou a usar quantidade e valor (top 10 com percentuais).
- Desvio por centro/setor aplica regra de concentracao (>= 30%) e outlier (media + 2 desvios).
- Cobertura por trabalhador agora considera consumo medio mensal por centro/setor e classifica status (OK/ATENCAO/CRITICO/SEM BASE).
- Arquivos alterados:
- `src/pages/RelatorioEstoque.jsx`
- `src/hooks/useRelatorioEstoque.js`
- `src/services/relatorioEstoqueApi.js`
- `src/services/api.js`
- `src/services/localApi.js`
- `src/utils/RelatorioEstoquePdfUtils.js`
- `src/utils/inventoryReportUtils.js`
- `src/components/AutoResizeIframe.jsx`
- `src/pages/RelatorioEstoque.jsx`
- `src/services/errorLogService.js`
- `src/lib/estoque.js`
- `src/help/helpRelatorioEstoque.json`
- `api/_shared/operations.js`
- `api/index.js`
- `shared/documents/relatorioEstoqueTemplate.js`
- `supabase/functions/relatorio-estoque-mensal/index.ts`
- `supabase/functions/relatorio-estoque-mensal-email/index.ts`
- `supabase/functions/relatorio-estoque-mensal/_shared/relatorioEstoqueCore.ts`
- `supabase/functions/relatorio-estoque-mensal-email/_shared/relatorioEstoqueEmailCore.ts`
- `supabase/migrations/20260218_add_inventory_report_email_fields.sql`
- `supabase/functions/relatorio-estoque-pdf/index.ts`
- Antes/Depois:
- Antes: os crons de relatorio nao registravam execucao em `edge_functions_error_report`.
- Depois: os crons de relatorio registram resumo da execucao em `edge_functions_error_report`.

Atualizacao 2026-02 (semanal)
-----------------------------
- Relatorio semanal com CSVs anexados por email (estoque atual, entradas, saidas, acidentes e HHT).
- Geracao semanal grava metadados no `inventory_report` com `tipo=semanal` e status de email.
- Coluna `arquivos_total` em `inventory_report` guarda a quantidade de CSVs gerados (semanal).
- Arquivos salvos no bucket `imports` em `<owner_id>/relatorios-semanais/<periodo>/`.
- Envio semanal usa Brevo com anexos (limite total 20MB).
- Envio semanal respeita limite de 99 destinatarios quando ha anexos.
- CSV de estoque atual usa saldo acumulado (todas as entradas/saidas) para refletir estoque real, mas total de entradas/saidas considera apenas a semana.
- Apenas materiais com movimentacao na semana entram no CSV de estoque atual.
- Arquivos alterados:
- `supabase/functions/relatorio-estoque-semanal/index.ts`
- `supabase/functions/relatorio-estoque-semanal/_shared/relatorioEstoqueSemanalCore.ts`
- `supabase/functions/relatorio-estoque-semanal-email/index.ts`
- `supabase/functions/relatorio-estoque-semanal-email/_shared/relatorioEstoqueSemanalEmailCore.ts`
- `supabase/functions/cleanup-import-errors/index.ts`

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- RelatorioEstoquePage
  - Tipo: componente de pagina React
  - Caminho: src/pages/RelatorioEstoque.jsx
  - Responsavel por: filtros, listagem e pre-visualizacao do relatorio.
- useRelatorioEstoque
  - Tipo: hook
  - Caminho: src/hooks/useRelatorioEstoque.js
  - Responsavel por: carregar historico, acionar geracao de PDF e tratar limites.
- EstoqueOperations.reportHistory / reportHtml / reportPdf
  - Tipo: operacoes backend
  - Caminho: api/_shared/operations.js
  - Responsavel por: listar relatorios, fornecer contexto e registrar geracao de PDF.
- relatorio-estoque-mensal / relatorio-estoque-mensal-email
  - Tipo: edge functions
  - Caminho: supabase/functions/relatorio-estoque-mensal/index.ts
  - Caminho: supabase/functions/relatorio-estoque-mensal-email/index.ts
  - Responsavel por: gerar dados mensais, enviar email HTML e registrar execucoes em edge_functions_error_report.
- relatorio-estoque-semanal / relatorio-estoque-semanal-email
  - Tipo: edge functions
  - Caminho: supabase/functions/relatorio-estoque-semanal/index.ts
  - Caminho: supabase/functions/relatorio-estoque-semanal-email/index.ts
  - Responsavel por: gerar CSVs semanais, enviar email com anexos e registrar execucoes em edge_functions_error_report.
- relatorioEstoqueCore
  - Tipo: utilitario de edge function
  - Caminho: supabase/functions/relatorio-estoque-mensal/_shared/relatorioEstoqueCore.ts
  - Responsavel por: montar dados e persistir em inventory_report.
  - Calcula ranking de consumo, desvios e cobertura por centro/setor.

Constantes e configuracoes
--------------------------
- PDF_REPORT_LIMIT_PER_MONTH
  - Tipo: configuracao
  - Caminho: src/config/RelatorioEstoqueConfig.js
  - Uso: limite mensal de geracao de PDF por relatorio.

Funcoes utilitarias relacionadas
--------------------------------
- downloadRelatorioEstoquePdf
  - Tipo: utilitario
  - Caminho: src/utils/RelatorioEstoquePdfUtils.js
  - Responsavel por: enviar HTML para renderizacao e baixar PDF.

Servicos e integracoes externas
-------------------------------
- relatorioEstoqueApi
  - Tipo: servico
  - Caminho: src/services/relatorioEstoqueApi.js
  - Responsavel por: listar relatorios e solicitar contexto/PDF.
- Supabase Functions (renderizacao PDF)
  - Tipo: integracao externa
  - Caminho: supabase/functions/relatorio-estoque-pdf
  - Responsavel por: converter HTML em PDF.
- Brevo (email HTML)
  - Tipo: integracao externa
  - Caminho: supabase/functions/relatorio-estoque-mensal-email/_shared/relatorioEstoqueEmailCore.ts
  - Responsavel por: envio de relatorios mensais.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpRelatorioEstoque.json.
- `supabase/functions/relatorio-estoque-pdf/index.ts`
