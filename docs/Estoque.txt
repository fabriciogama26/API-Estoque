Tela: Estoque Atual
===================

Visao geral
-----------
- Consolida o saldo atual por material, exibindo quantidade, valor e alertas de estoque minimo.
- Permite ajustar o estoque minimo por material via modal de alteracao.
- Traz acoes rapidas por material (Entrada, Saida e Alterar minimo) para agilizar o registro de movimentacoes.
- Carrega dados via `api.estoque.current({ periodoInicio, periodoFim })`, retornando `itens` e `alertas`.

Arquitetura (modular)
---------------------
- Hook/Contexto:
  - `useEstoque` + `EstoqueContext` cuidam dos dados, filtros, estados de loading/erro e funcoes de recarga.
  - Implementam cache de chave de filtros para evitar recargas repetidas.
- Filtros:
  - `useEstoqueFiltro` isola a logica de filtros e seus valores padrao.
- Regras:
  - `estoqueRules` agrupa validacoes e regras de negocio (estoque minimo, campos obrigatorios).
- Servicos:
  - `dataClient.estoque.current` (ou service equivalente) obtém saldo/alertas.
  - `api.materiais.update` (ou similar) salva mudanças de `estoqueMinimo` por material.
- Erros:
  - `useErrorLogger('estoque')` registra falhas de carga e erro em atualizacoes de estoque minimo.

Filtros
-------
- Periodo inicial/final (mes/ano) so e aplicado quando "Movimentacao do periodo" esta ativo.
- Com "Movimentacao do periodo" desligado, o estoque mostra o saldo fisico acumulado (posicao atual).
- Com "Movimentacao do periodo" ativo, a lista mostra apenas materiais com movimentacao no intervalo (saldo pode ficar negativo).
- Termo de busca (nome do material, fabricante, centro).
- Centro de estoque/servico.
- Quantidade (>= valor) para filtrar por saldo minimo exibido.
- Checkboxes:
  - "Apenas zerado": mantem somente materiais com quantidade 0.
  - "Apenas saidas": mantem somente materiais com movimentacao de saida registrada (sino ativo).
  - "Apenas alertas": mant?m somente materiais com alerta ativo.
  - "Movimentacao do periodo": aplica o intervalo de datas para calcular entradas/saidas.
  - "Apenas com hist?rico de sa?das": mant?m somente materiais que j? possuem movimenta??o de sa?da (sino ativo). ?til para focar em itens que j? foram entregues pelo menos uma vez.

- Botoes:
  - "Aplicar filtros" consulta na API (sem refiltro local em memoria).
  - "Limpar filtros" restaura defaults e recarrega a visao padrao a partir da API.

Alertas
-------
- Cards de alerta mostram, para cada material critico:
  - Quantidade atual.
  - Estoque minimo configurado.
  - Deficit (quanto falta para atingir o minimo).
  - Valor estimado de reposicao (deficit × valor unitario).
- Apenas itens dentro dos filtros entram no calculo de alertas.
- Se nao houver alertas, exibe mensagem neutra.

Resumo geral
------------
- Calculado com base nos itens filtrados:
  - Total em estoque (R$) – soma de quantidade × valor unitario.
  - Total de itens – quantidade de materiais distintos listados.
  - Valor de reposicao – soma dos valores associados aos deficits.
  - Data da ultima movimentacao relacionada ao material.
- Geralmente calculado via `useMemo` para nao recalcular desnecessariamente.
- Resumo e alertas seguem o modo selecionado (saldo acumulado ou movimentacao do periodo).

Lista de itens
--------------
- Cada linha/cartao exibe:
  - Nome do material, fabricante, categoria (quando disponivel).
  - ID do material e cor (quando disponivel).
  - Quantidade atual em estoque.
  - Valor unitario e valor total (formatados em BRL).
  - Informacoes adicionais: validade (em dias), CA, centro(s) de custo, data e usuario da ultima atualizacao.
- Acoes por material:
  - Entrada: abre a tela de Entradas e tenta preencher Material + Centro de estoque automaticamente.
  - Saida: abre a tela de Saidas e tenta preencher Centro de estoque + Material automaticamente (centro e obrigatorio para habilitar o campo de material).
  - Sino de historico: abre um modal com todas as saídas do material (ativo apenas se houver movimentação). O modal traz tabela com quem recebeu, matrícula, quantidade, data e autorizado, e permite filtrar por mês/ano.
  - Alterar minimo: abre um modal para informar o novo estoque minimo e salvar.
  - Observacao: quando houver mais de um centro relacionado ao material, o atalho usa o primeiro centro encontrado no contexto do estoque atual.
- Estoque minimo (alteracao):
  - Clique em "Alterar minimo" para abrir o modal.
  - Ao salvar, chama `api.materiais.update` com `estoqueMinimo` e `usuarioResponsavel`.
  - Em caso de sucesso, recarrega dados do estoque atual.
  - Em caso de erro, mostra feedback e bloqueia o botao enquanto a operacao estiver em andamento.
- Exportacao CSV:
  - Sempre exporta a posicao fisica acumulada (ignora movimentacao do periodo).
  - Botao "Atualizar" recarrega a lista aplicando os filtros atuais.

Boas praticas
-------------
- Configurar politicas no Supabase para permitir update de `estoque_minimo` apenas por usuarios autenticados/autorizados.
- Manter `localApi.estoque.current` (modo local) alinhado com a estrutura esperada (`alertas` + `itens`) para facilitar testes.
- Utilizar "Movimentacao do periodo" para inspecionar entradas/saidas do intervalo antes de gerar relatorios oficiais.

Melhoria possivel
-----------------
- Criar um RPC no Supabase para calcular o saldo do Estoque atual (com corte por data inicio/fim), reduzindo trafego e CPU no frontend; deve respeitar account_owner_id/RLS.

Atualizacao 2026-01
-------------------
- Arquivos alterados:
  - src/services/api.js
  - src/services/localApi.js
  - src/lib/estoque.js
  - src/help/helpEstoque.json
  - src/styles/EstoquePage.css
  - docs/Estoque.txt
  - src/components/icons.jsx
  - src/components/Estoque/Filters/EstoqueFilters.jsx
  - src/components/Estoque/Filters/EstoqueMovimentacaoHelpButton.jsx
  - src/hooks/useEstoque.js
  - src/hooks/useEstoqueFiltro.js
  - src/context/EstoqueContext.jsx
  - src/pages/EstoquePage.jsx
- Funcoes/hooks tocadas:
  - api.estoque.current (movimentacao do periodo vs saldo acumulado)
  - localApi.estoque.current (movimentacao do periodo vs saldo acumulado)
  - montarEstoqueAtual (includeAll quando em movimentacao)
  - useEstoque/useEstoqueFiltro (dados base e exportacao)
  - EstoqueFilters/EstoquePage (toggle + CSV acumulado + botao atualizar)
- Comportamento antes/depois:
  - Antes: o botao "Aplicar filtros" enviava um payload incorreto e os filtros da tela nao eram aplicados.
  - Depois: o botao usa os filtros atuais do formulario e aplica corretamente na lista e no resumo.
  - Lista mostra saldo acumulado por padrao; "Movimentacao do periodo" aplica o intervalo e filtra apenas materiais com movimentacao.
  - CSV exporta sempre a posicao fisica acumulada.

Atualizacao 2025-12
-------------------
- Tela refatorada para hook/context com carregamento silencioso e sem flicker no botao de filtro.
- Cache de chave de filtros reduz chamadas repetidas.

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- EstoquePage
  - Tipo: componente de pagina React
  - Caminho: src/pages/EstoquePage.jsx
  - Responsavel por: orquestrar filtros, cards e alertas consumindo o contexto de estoque/dashboard.
- useEstoqueFiltro
  - Tipo: hook de filtros
  - Caminho: src/hooks/useEstoqueFiltro.js
  - Responsavel por: manter filters, handleFilterChange/Clear e evitar reload quando params nao mudam.
- EstoqueContext / DashboardEstoqueContext
  - Tipo: contexto
  - Caminho: src/context/EstoqueContext.jsx
  - Responsavel por: compartilhar filtros, alertas, tamanhos de pagina, loading e handlers de recarga para cards.
- Modais do Estoque (saidas e estoque minimo)
  - Tipo: componentes de UI
  - Caminho: src/components/Estoque/Modal/EstoqueSaidaModal.jsx e src/components/Estoque/Modal/EstoqueMinStockModal.jsx
  - Responsavel por: exibir historico de saidas e ajustar estoque minimo.
- useDashboardEstoque
  - Tipo: hook de dados/dashboard
  - Caminho: src/hooks/useDashboardEstoque.js
  - Responsavel por: carregar indicadores, preparar series/rankings e cachear chave de busca para remover flicker.

Constantes e configuracoes
--------------------------
- Configs de paginação/limites (ex.: alertasPageSize)
  - Tipo: constantes de contexto
  - Caminho: src/context/EstoqueContext.jsx
  - Uso: define tamanhos de pagina de alertas e cards.

Funcoes utilitarias relacionadas
--------------------------------
- formatadores e builders de series/rankings
  - Tipo: utilitarios
  - Caminho: src/utils/dashboardEstoqueUtils.js, src/utils/estoqueUtils.js
  - Responsavel por: formatar valores, montar graficos e dados de alerta.

Servicos e integracoes externas
-------------------------------
- dashboardEstoqueApi / estoqueApi
  - Tipo: servicos de API
  - Caminho: src/services/dashboardEstoqueApi.js, src/services/estoqueApi.js
  - Responsavel por: buscar dados consolidados de estoque e indicadores.
- entradasService / saidasService / materiaisService
  - Tipo: servicos de API
  - Caminho: src/services/entradasService.js, src/services/saidasService.js, src/services/materiaisService.js
  - Responsavel por: dados auxiliares para cards e alertas.
- Integracao com `useErrorLogger('estoque')` para registrar erros criticos.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpEstoque.json; edite titulos/steps/notes e midias (/public/help/estoque/*).

