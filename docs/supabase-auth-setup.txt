Guia de Autenticação Supabase
=============================

Visão geral
-----------
- O frontend usa o Supabase Auth via SDK oficial (`supabase.auth`) para login, com tokens armazenados pelo próprio cliente e replicados no `localStorage` quando disponíveis.【F:src/context/AuthContext.jsx†L1-L168】
- As chamadas de dados partem diretamente do navegador usando `@supabase/supabase-js`; não há backend obrigatório além de funções opcionais em `api/`/`supabase/functions`.
- A tabela `public.app_users` (criada nas migrations iniciais) pode mapear perfis autenticados para metadados internos se necessário.【F:supabase/README.md†L12-L55】

Passo a passo de configuração
-----------------------------
1. **Projeto Supabase**
   - Crie um projeto em https://app.supabase.com e anote o `project-ref`.
   - Em *Authentication > Settings* configure provedores, confirmação de e-mail e URLs de redirecionamento (inclua `http://localhost:5173` para desenvolvimento e o domínio de produção).
2. **Chaves e variáveis**
   - Defina `VITE_SUPABASE_URL` e `VITE_SUPABASE_ANON_KEY` no `.env.local` e no ambiente de deploy. A chave `service_role` deve permanecer apenas em rotinas server-side (funções em `api/` ou `supabase/functions`).【F:README.md†L27-L66】
3. **Aplicar schema e políticas**
   - No diretório `supabase/`, execute:
     ```bash
     supabase link --project-ref <project-ref>
     supabase db push
     ```
   - O comando aplica as migrations até `0027_expand_material_history.sql`, criando tabelas principais, catálogos de domínio e habilitando RLS.【F:supabase/README.md†L12-L55】
4. **RLS e perfis**
   - Políticas padrão permitem leitura para `authenticated` e escrita controlada; ajuste conforme perfis seguindo [`docs/rls-policies-guide.txt`](rls-policies-guide.txt).
   - Caso use claims customizadas (ex.: `is_admin`), crie migrations adicionais para aplicar políticas específicas.
5. **Usuários de teste**
   - Cadastre contas em *Authentication > Users* ou via CLI (`supabase auth signups start`). Para vincular à tabela `app_users`, crie um registro usando o mesmo UUID (`id`) retornado pelo Supabase para o usuário e preencha `username`/`display_name`.
6. **Desenvolvimento local**
   - `supabase start` + `supabase db reset` reproduzem o stack local (requer Docker). Sincronize variáveis com `supabase env pull/push` quando necessário.【F:supabase/README.md†L57-L102】
7. **Recuperação de senha**
   - Personalize o template “Reset password” e configure remetente/URL em *Authentication > Templates/Settings*.
   - Defina `VITE_SUPABASE_PASSWORD_REDIRECT` para apontar para a página de redefinição; o frontend envia o valor ao chamar `resetPasswordForEmail`.【F:src/context/AuthContext.jsx†L150-L200】

Observações importantes
-----------------------
- O SDK já envia `Authorization: Bearer <access_token>` automaticamente; evite duplicar cabeçalhos.
- Funções serverless que usam `service_role` devem validar o cabeçalho `apikey` para impedir uso indevido (ver exemplo em `supabase/functions/termo-epi`).【F:supabase/functions/termo-epi/index.ts†L1-L160】
- Após alterar políticas ou provedores, teste login/logout no frontend e execute `supabase db status` para garantir que não existem migrations pendentes.


Atualizacao 2025-11
--------------------
- Reforcei a necessidade de propagar `user` no contexto, pois o dashboard so renderiza os novos botoes de expandir quando ha sessao valida.
- Inclui orientacao para validar que refresh tokens continuam disponiveis ao abrir e fechar as modais de grafico, evitando erros silenciosos.
