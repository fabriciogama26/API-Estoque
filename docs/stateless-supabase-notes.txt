Notas de Migração Stateless
===========================

> Desde 2025-10 o frontend também suporta modo de dados local. Consulte [`docs/data-mode-guide.txt`](data-mode-guide.txt) para orientações.

Visão geral da arquitetura
--------------------------
- O frontend (Vite/React) é publicado como assets estáticos (ex.: Vercel).
- Todas as requisições de dados partem do navegador usando `@supabase/supabase-js`; não há camada obrigatória de backend.
- Os tokens do Supabase Auth são mantidos pelo SDK e utilizados em cada chamada, respeitando as políticas RLS configuradas.

Variáveis de ambiente
---------------------
- `VITE_SUPABASE_URL`: URL pública do projeto Supabase.
- `VITE_SUPABASE_ANON_KEY`: chave `anon` (respeita RLS).
- `VITE_DATA_MODE`: `remote` para Supabase, `local` para persistir no navegador.
- Variáveis opcionais para o termo de EPI (`VITE_TERMO_EPI_EMPRESA_*`) e modo local (`VITE_LOCAL_*`).

Expectativas do schema Supabase
-------------------------------
As migrations em `supabase/migrations` já alinham as tabelas esperadas. Principais entidades:
- `pessoas`: inclui campos de centro de serviço, setor, cargo, tipo de execução, data de admissão e histórico (`pessoas_historico`).
- `materiais`: contém validações de estoque mínimo, histórico de preço (`material_price_history`) e chave única por grupo/número.
- `entradas` / `saidas`: registram movimentações com auditoria (`usuarioResponsavel`, `dataEntrada`, `dataEntrega`, `dataTroca`).
- `acidentes`: armazena dados completos de SST, vinculando-se às tabelas de domínio (`acidente_agentes`, `acidente_partes`, `acidente_lesoes`, `acidente_tipos`).
- Tabelas de referência: centros de serviço, centros de custo, setores, cargos, tipos de execução e catálogos de acidentes.

Fluxo de dados no frontend
--------------------------
- `src/services/api.js` monta queries Supabase, normaliza registros (`map*Record`) e reaproveita funções de domínio (`src/lib`).
- `src/services/localApi.js` oferece o mesmo contrato utilizando o seed local.
- Dashboards e cálculos (estoque atual, agregações de acidentes, termo de EPI) são executados no cliente via helpers puros.

Destaques da lógica de negócios
-------------------------------
- Pessoas: valida campos obrigatórios, garante matrícula única e registra histórico de alterações.
- Materiais: valida grupos, numerações específicas e gera histórico de preço a cada mudança de `valorUnitario`.
- Entradas: verifica existência do material e registra centro de custo e responsável.
- Saídas: checa saldo disponível (`calcularSaldoMaterialAtual`), calcula `dataTroca` e vincula colaborador/centro de serviço.
- Termo de EPI: combina dados de pessoas e saídas para montar o documento, com geração de PDF client-side.
- Dashboards: `montarDashboard` e `montarDashboardAcidentes` recalculam métricas sob demanda.

Recomendações de segurança
--------------------------
- Habilite RLS em todas as tabelas e crie políticas específicas para cada perfil (ver [`docs/rls-policies-guide.txt`](rls-policies-guide.txt)).
- Para funções serverless opcionais, use a chave `service_role` apenas no backend e adicione políticas explícitas (`auth.role() = 'service_role'`).
- Monitore acessos sensíveis (históricos, indicadores) e registre auditoria quando necessário.

Próximos passos sugeridos
-------------------------
- Configurar provedores de autenticação (email, OAuth) no painel Supabase.
- Popular tabelas de domínio (centros, cargos, agentes) antes de liberar o cadastro operacional.
- Automatizar migrations no pipeline de deploy (`supabase db push`).
- Avaliar métricas de uso e, se necessário, criar views/materialized views para dashboards pesados.
- Revisar periodicamente políticas de acesso e documentar mudanças neste diretório.
