Notas de Migração Stateless
===========================

> Desde 2025-10 o frontend também suporta modo de dados local. Consulte [`docs/data-mode-guide.txt`](data-mode-guide.txt) para orientações.

Visão geral da arquitetura
--------------------------
- O frontend (Vite/React) é publicado como assets estáticos (ex.: Vercel). Todas as telas consomem dados direto do Supabase ou da API local sem backend próprio.
- As chamadas utilizam `@supabase/supabase-js` configurado em `src/services/api.js`, incluindo funções utilitárias para montar dashboards e calcular saldo de estoque.【F:src/services/api.js†L1-L48】
- Os tokens do Supabase Auth são mantidos pelo SDK e reutilizados em cada requisição, respeitando as políticas RLS configuradas.

Variáveis de ambiente
---------------------
- `VITE_SUPABASE_URL`: URL pública do projeto Supabase.
- `VITE_SUPABASE_ANON_KEY`: chave `anon` usada pelo SDK.
- `VITE_DATA_MODE`: `remote` (padrão) ou `local` (usa `localStorage`).【F:src/config/runtime.js†L1-L12】
- `VITE_TERMO_EPI_EMPRESA_*`, `VITE_SUPABASE_PROXY_URL` (ou `VITE_API_URL`), `VITE_LOCAL_*` complementam recursos de documentos e modo offline.【F:src/utils/TermoEpiUtils.js†L1-L94】【F:src/context/AuthContext.jsx†L7-L84】

Expectativas do schema Supabase
-------------------------------
- Migrations em `supabase/migrations` criam as tabelas e políticas esperadas. Destaques:
  - `pessoas` + `pessoas_historico` armazenam dados cadastrais e auditoria.
  - `materiais` + `material_price_history` tratam estoque mínimo e histórico de preços.
  - `entradas`/`saidas` registram movimentações com campos de auditoria (`usuarioResponsavel`, datas).
  - `acidentes` relaciona agentes/tipos/partes/lesões (migrations 0014-0017) para alimentar a tela e dashboards.【F:supabase/README.md†L12-L55】

Fluxo de dados no frontend
--------------------------
- `src/services/api.js` executa queries Supabase e normaliza registros via helpers (`montarEstoqueAtual`, `montarDashboard`, `montarDashboardAcidentes`).【F:src/services/api.js†L1-L48】
- `src/services/localApi.js` replica o mesmo contrato utilizando seeds em `src/data/local-seed.json`, permitindo desenvolvimento offline.【F:src/services/localApi.js†L1-L160】
- Regras de domínio ficam em `src/lib/` e `src/rules/`, reaproveitadas por páginas e serviços.

Destaques da lógica de negócios
-------------------------------
- Pessoas: valida matrícula, sincroniza centro de serviço/local e gera histórico ao alterar registros.【F:src/pages/Pessoas.jsx†L52-L210】
- Materiais: controla catálogos de grupo/itens, características, cores e histórico de preço a cada alteração de valor unitário.【F:src/pages/Materiais.jsx†L33-L521】
- Entradas/Saídas: usam catálogos carregados previamente, calculam valores monetários e registram responsável autenticado.【F:src/pages/EntradasPage.jsx†L29-L276】【F:src/pages/SaidasPage.jsx†L1-L318】
- Estoque/Dashboards: cálculos são feitos client-side via hooks e helpers (`agruparPorPeriodo`, `montarRanking`, `montarEstoquePorMaterial`).【F:src/pages/DashboardPage.jsx†L41-L213】
- Termo de EPI: combina dados de colaboradores e entregas para gerar HTML e PDF através da função serverless.【F:src/pages/TermosEpiPage.jsx†L1-L178】【F:src/utils/TermoEpiUtils.js†L1-L94】

Recomendações de segurança
--------------------------
- Habilite RLS em todas as tabelas e mantenha políticas atualizadas (ver [`docs/rls-policies-guide.txt`](rls-policies-guide.txt)).
- Funções serverless devem usar `service_role` apenas no backend e validar `apikey` em cada requisição.【F:supabase/functions/termo-epi/index.ts†L1-L160】
- Monitore logs do Supabase (Auth/SQL) para auditar acessos a históricos e dashboards.

Próximos passos sugeridos
-------------------------
- Configurar provedores adicionais de autenticação (email magic link, OAuth) no painel Supabase.
- Popular tabelas de domínio antes de liberar o cadastro operacional (centros de serviço, cargos, agentes, lesões, tipos).
- Automatizar migrations no pipeline (`supabase db push`) e revisar periodicamente com `supabase db pull`.
- Documentar alterações relevantes neste diretório para manter o time alinhado.


Atualizacao 2025-11
--------------------
- Adicionei nota explicando que os novos filtros clicaveis dependem apenas de leitura agregada; portanto continuam funcionando mesmo com clients stateless, desde que os caches incluam os campos extras.
- Detalhei que o modal fullscreen nao mantem estado de sessao proprio, reduzindo o risco de inconsistencias em ambientes sem armazenamento local.
