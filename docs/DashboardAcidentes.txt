Tela: Dashboard de Acidentes
============================

Visao geral
-----------
- Reune indicadores de seguranca do trabalho com base nos acidentes registrados.
- Exibe taxas (frequencia, gravidade), dias perdidos/debitados, IA, IAG, IRA e distribuicoes por agente, tipo, parte lesionada, lesao principal e cargo.
- Funciona em:
  - Modo local: `localApi.acidentes.dashboard`.
  - Modo remoto: view `vw_indicadores_acidentes` no Supabase.

Fluxo de carregamento
---------------------
1. Ao montar, aplica filtros padrao (ano/periodo corrente) e carrega os dados.
2. Modo remoto (padrao):
   - Consulta a view `vw_indicadores_acidentes` (taxas calculadas em SQL usando `hht_mensal` por centro/mes e apenas acidentes `ativo=true`).
   - Normaliza colunas para o formato interno (`resumo`, `tendencia`, `tipos`, `partes_lesionadas`, `cargos`, `agentes`, `lesoes`) e monta o label do periodo com base nos filtros.
3. Fallback local:
   - Se a view falhar, usa `localApi.acidentes.dashboard`/`montarDashboardAcidentes` (JS) com HHT mensal carregado de `hht_mensal_view`.
   - API retorna objeto com: `resumo`, `tendencia`, `tipos`, `partesLesionadas`, `cargos`, `agentes`, `options`.

Filtros suportados
------------------
- Ano.
- Unidade (todas ou especifica).
- Periodo inicial/final.
- Centro de servico.
- Tipo de acidente.
- Lesao.
- Parte lesionada.
- Agente.
- Cargo.
- Alteracoes atualizam o estado local de filtros.
- "Aplicar" dispara `load(filters)`.
- "Limpar" restaura `initialFilters()` (filtros padrao).

Componentes visuais
-------------------
- `DashboardCards`:
  - Mostram totais de acidentes, taxa de frequencia (TF), taxa de gravidade (TG) e dias perdidos/debitados.
  - Segunda fileira com IA, IAG e IRA.
  - TF/TG exibem badges com classificacao por faixas (ex.: inspiradas em OIT).
- `ChartTendencia`:
  - Curva temporal (por mes) da serie `tendencia`.
- `ChartTipos`, `ChartAgentes`, `ChartPartesLesionadas`, `ChartCargos`:
  - Graficos categorizados (barras/pizza) para distribuiçoes de acidentes.
  - Tratam dados vazios exibindo mensagem neutra no lugar do grafico.
- `ChartLesoes`:
  - Barras horizontais com frequencia das lesoes principais (campo `lesoes`).
- `FiltrosDashboard`:
  - Exibe selects dinamicos conforme `options` (modo local).
  - No modo remoto, se nao houver opcoes, mantém apenas a opcao "todas" para cada filtro.

Erros e pre-requisitos
----------------------
- Supabase:
  - Quando `VITE_SUPABASE_URL` ou `VITE_SUPABASE_ANON_KEY` nao estiverem configuradas (fora do modo local), a tela exibe aviso para ajustar as variaveis de ambiente.
- View `vw_indicadores_acidentes`:
  - Deve ser criada/atualizada nas migrations (usa `hht_mensal` em vez de campo HHT no acidente).
  - Filtra acidentes por `ativo=true` e ignora cancelados.
  - Precisa expor: taxas classicas (TF, TG), `dias_debitados`, `total_trabalhadores`, `indice_acidentados`, `indice_avaliacao_gravidade`, `indice_relativo_acidentes`.
- Seeds locais:
  - `localApi.acidentes.dashboard` deve conter dados de exemplo para testes offline.
- Erros:
  - `useErrorLogger('dashboard_acidentes')` registra falhas de consulta e normalizacao.

Arquitetura e comportamento
---------------------------
- Contexto + hook:
  - `DashboardAcidentesContext` e `useDashboardAcidentes` centralizam `filters`, `data`, `isLoading`, `error` e logica de filtros clicaveis.
  - Ha cache de chave de filtros para evitar recargas a cada digitacao.
- Filtros clicaveis:
  - Clicar em um segmento de grafico pode aplicar filtro direto (ex.: focar em um agente ou tipo).
  - Um botao ou badge permite limpar o filtro clicavel rapidamente.

Atualizacao 2025-12
-------------------
- Fluxo modular consolidado: pagina apenas orquestra contexto/hook, filtros, cards e graficos.
- Padrão de filtros clicaveis alinhado ao dashboard de estoque.

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- DashboardAcidentes
  - Tipo: componente de pagina React
  - Caminho: src/pages/DashboardAcidentes.jsx
  - Responsavel por: montar filtros, cards e graficos consumindo o contexto/hook de dashboard de acidentes.
- useDashboardAcidentes
  - Tipo: hook de dados/dashboard
  - Caminho: src/hooks/useDashboardAcidentes.js
  - Responsavel por: carregar indicadores SST, preparar series/rankings, controlar filtros e cachear chave de busca para evitar recargas.
- DashboardAcidentesContext / Provider
  - Tipo: contexto
  - Caminho: src/context/DashboardAcidentesContext.jsx (quando presente)
  - Responsavel por: compartilhar filtros, dados, isLoading/error e handlers (aplicar/limpar/expandir graficos).

Constantes e configuracoes
--------------------------
- Defaults de filtros/estado
  - Tipo: configuracao
  - Caminho: src/config/DashboardAcidentesConfig.js (ou constantes no hook)
  - Uso: estado inicial de filtros e colecoes.

Funcoes utilitarias relacionadas
--------------------------------
- formatadores e builders de indicadores SST
  - Tipo: utilitarios
  - Caminho: src/utils/dashboardAcidentesUtils.js
  - Responsavel por: formatar TF/TG/IA/IAG/IRA, montar series, rankings e labels/legendas.

Servicos e integracoes externas
-------------------------------
- dashboardAcidentesApi
  - Tipo: servico de API
  - Caminho: src/services/dashboardAcidentesApi.js
  - Responsavel por: buscar dados consolidados de acidentes (Supabase ou local via dataClient).

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpContent.json (chave 'dashboardAcidentes'); edite ali para ajustar titulos/steps/notes.
- Para imagens, salve em public/help/dashboardAcidentes/ e aponte no campo 'media' do passo (ex.: /help/dashboardAcidentes/exemplo.webp).

Atualizacao 2026-01
-------------------
- Dashboard consome a view `vw_indicadores_acidentes` primeiro (SQL com `hht_mensal` e acidentes `ativo=true`); fallback JS so ocorre em caso de falha.
- TF/TG/IA/IAG/IRA calculadas na view com HHT mensal do centro/mes; acidentes cancelados nao entram nos calculos.



Atualizacao 2026-01 (UI)
- Modal de expansao isolado em src/components/Dashboard/ChartExpandModal.jsx.
- Ajuda: src/help/helpDashboardAcidentes.json.
