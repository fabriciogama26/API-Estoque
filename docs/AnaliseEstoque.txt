Tela: Analise de Estoque
========================

Visao geral
-----------
- Tela dedicada a interpretacao dos Paretos e acoes recomendadas de estoque.
- Usa os mesmos filtros do Dashboard de Estoque (periodo e termo).
- Exibe cartoes de decisao, Paretos e blocos de interpretacao/acao ao lado.
- Inclui previsao de fluxo anual (entradas, saidas e saldo) baseada no consumo medio dos ultimos 12 meses.

Arquitetura
-----------
- Provider `DashboardEstoqueProvider`:
  - Reaproveita a carga de dados e filtros do dashboard.
- Pagina `AnaliseEstoquePage`:
  - Monta cartoes com regras de concentracao, risco, financeiro e recomendacoes.
  - Renderiza Paretos com interpretacao e acoes ao lado.
  - Busca previsao anual via endpoint de estoque (nao usa filtros).
- Componentes:
  - `ParetoChart` para os graficos.
  - `ChartExpandModal` para visualizacao expandida.
  - `ForecastGastoChart` para historico mensal e projecao.
 - Tabelas:
   - `agg_gasto_mensal` (agregado mensal real por tenant).
   - `f_previsao_gasto_mensal` (previsao mensal por tenant).

Cadastro
--------
- Nao aplicavel.

Filtros, auto-complete e listagem
---------------------------------
- Periodo inicial/final (AAAA-MM).
- Termo livre (material, fabricante, categoria, centro, setor, pessoa).
- Aplicacao sob demanda: filtros sao aplicados apenas ao clicar em **Aplicar filtros**.

Boas praticas
-------------
- Valor unitario e giro diario direcionam o cartao de itens caros com baixo giro.
- Use os cartoes de recomendacao para orientar compras e revisao de politicas.
- Filtros de periodo afetam consumo, nao afetam estoque atual (sempre acumulado).
- Pareto de score de risco ordena pelo score e usa cores por faixa (alto/medio/baixo).
- Previsao rolling usa os ultimos 12 meses quando disponiveis, mas aceita minimo de 6 meses com dados.
- Base de previsao considera o ultimo mes com dados e preenche meses sem movimento com zero.
- Se existir previsao aberta (qtd_meses_base < 12), o RPC reutiliza o mesmo periodo_base_inicio e atualiza ate completar 12.
- Previsao mensal e agregados sao gerados por cron via Edge Function.
- A previsao mensal usa metodo sazonal: media movel 3m e fator sazonal por mes, multiplicado pelo fator_tendencia.
- Fator_tendencia = 0.6*(ultimos 3m / anteriores 3m) + 0.4*(1 + slope*30*6/ultimos 3m).
- O periodo exibido pode ser trocado pelo select com historicos gravados em `inventory_forecast`.
- O botao Validacao na previsao exibe tabelas de `agg_gasto_mensal` e `f_previsao_gasto_mensal`.
- O botao Diagnostico executa `diagnosticar_estatisticas_mensais` e exibe percentis mensais.
- O modal de validacao mostra as formulas de fator_tendencia, sazonalidade e previsao mensal.
- Cron oficial roda via Edge Function `forecast-gasto-mensal` (schedule 0 3 28-31 * *), com checagem de ultimo dia do mes e suporte a force no body.
- Para testes por periodo, usar `rpc_previsao_gasto_mensal_calcular_periodo(p_owner_id, p_periodo_inicio, p_periodo_fim, p_fator_tendencia)` (grava forecast e inventory_forecast).
- A RPC por periodo nao bloqueia por falta de movimento; registra `monthsSpan`, `monthsWithMovement` e ajusta `nivel_confianca`.
- A RPC por periodo usa a maior sequencia continua de meses com movimento (6..12). Se a melhor sequencia for < 6, retorna `insufficient`.
- Retorna `usedMonths`, `periodo_usado_inicio` e `periodo_usado_fim`, com confianca baseada no tamanho da sequencia (6-7 baixo, 8-10 medio, 11-12 alto).
- `variacao_percentual` e `tipo_tendencia` nunca sao nulos. Regra: sem base -> 0 e `sem_base`, senao usa +-2% como corte.
- `tipo_tendencia` e baseado na variacao vs periodo anterior (>=2% subida, <=-2% queda, senao estavel).
- Previsao no front le direto do Supabase quando em modo remoto (sem depender de API).
- O select de periodo usa `inventory_forecast` e lista todos os historicos do tenant (por id).
- RPCs de previsao atualizam `inventory_forecast_id` automaticamente em `f_previsao_gasto_mensal` (backfill do periodo).
- O card exibe a sazonalidade media do periodo com base na media movel de 3 meses.
- Tooltip da previsao inclui contingencia (P75), P90, mediana e alerta de volatilidade (CV > 1) calculados no RPC.
- Previsao considera entradas, saidas e saldo anual no card e no grafico.
- Previsao de entrada usa media movel 3m de entrada e fator sazonal de entrada.
- Diagnostico usa agg_gasto_mensal (valor_saida) como base estatistica.
- Respeitar `account_owner_id` em todas as consultas (multi-tenant).

Cancelamento e saldo
--------------------
- Nao aplicavel.

Atalhos
-------
- Clique nas barras com ID para copiar o materialId.

Atualizacao 2026-02
-------------------
- Nova pagina de Analise de Estoque em `/analise-estoque`.
- Paretos movidos do Dashboard para esta pagina.
- Cartoes de decisao agrupados com informativo (classe A por quantidade, risco ABC, concentracao do gasto, alertas de giro, anomalias e recomendacoes).
- Interpretacoes e acoes exibidas ao lado de cada Pareto.
- Textos dos Paretos agora incluem resumo com numeros e listas curtas (top 3-5 itens).
- Validacao do Pareto agora abre em modal com tabela base paginada (10 itens por pagina).
- Pareto de score de risco tambem possui modal de validacao com flags e classe ABC.
- Estoque atual do Pareto de risco usa o saldo fisico acumulado (mesma base da tela Estoque atual).
- Classe de risco operacional segue regra: A = abaixo minimo + giro alto, B = abaixo minimo sem giro alto, C = acima minimo.
- Pareto financeiro agora possui validacao com valor total de saida, percentuais e classe ABC financeira.
- Cartao de previsao anual e grafico de historico mensal com projecao.
- Tabelas `agg_gasto_mensal` e `f_previsao_gasto_mensal` adicionadas para historico e previsao mensal.
- Endpoint `/api/estoque/previsao` retorna dados apenas das tabelas agregadas.
- Edge Function `forecast-gasto-mensal` dispara a previsao mensal para todos os tenants.
- rpc_refresh_gasto_mensal agora ignora saidas canceladas via status_saida (evita erro de UUID e garante agregados corretos).
- Ajuda contextual criada para a pagina.
- Requisicao de previsao (`/api/estoque/previsao`) agora inclui `X-Session-Id` para manter o guard de sessao consistente.
- Arquivos alterados:
- `src/services/api.js`
- Antes/Depois:
- Antes: a previsao era solicitada sem `X-Session-Id`.
- Depois: a previsao inclui `X-Session-Id` para manter a sessao consistente no backend.

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- AnaliseEstoquePage
  - Tipo: componente de pagina React
  - Caminho: src/pages/AnaliseEstoquePage.jsx
  - Responsavel por: montar filtros, cartoes, Paretos e interpretacoes.
- ForecastGastoChart
  - Tipo: componente de grafico
  - Caminho: src/components/charts/ForecastGastoChart.jsx
  - Responsavel por: exibir historico mensal e projecao de gasto anual.
- DashboardEstoqueProvider
  - Tipo: provider React
  - Caminho: src/context/DashboardEstoqueContext.jsx
  - Responsavel por: prover dados e filtros para a analise.

Constantes e configuracoes
--------------------------
- Regras de Pareto e percentis
  - Tipo: utilitarios
  - Caminho: src/utils/inventoryReportUtils.js
  - Uso: calculo de percentis, formatos e listas de Pareto.

Funcoes utilitarias relacionadas
--------------------------------
- computePercentile / formatPercent / formatNumber / formatCurrency
  - Tipo: utilitarios
  - Caminho: src/utils/inventoryReportUtils.js
  - Responsavel por: percentis e formatacoes exibidas nos cartoes.

Servicos e integracoes externas
-------------------------------
- dashboardEstoqueApi
  - Tipo: servico de API
  - Caminho: src/services/dashboardEstoqueApi.js
  - Responsavel por: buscar dados do dashboard usados na analise.
- estoqueApi
  - Tipo: servico de API
  - Caminho: src/services/estoqueApi.js
  - Responsavel por: carregar o saldo fisico acumulado usado no Pareto de risco.
- estoqueApi (previsao)
  - Tipo: servico de API
  - Caminho: src/services/estoqueApi.js
  - Responsavel por: carregar previsao de gasto anual e atualizar fator de tendencia.
- RPCs de previsao
  - Tipo: SQL (Supabase)
  - Caminho: supabase/migrations/20260204_create_gasto_forecast_tables.sql
  - Responsavel por: gerar agregados mensais e previsoes por tenant.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpAnaliseEstoque.json (chave 'analiseEstoque').

