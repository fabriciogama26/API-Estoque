Tela: Termo de EPI

Visao geral

Gerar e baixar o termo de responsabilidade de EPI para colaboradores, com pre-visualizacao HTML e PDF renderizado via Edge Function usando proxy /api/supabase e cookie HttpOnly.

Arquitetura (modular)

- Hook useTermoEpi: controla formulario, validacao, carga do contexto, preview HTML e download do PDF.
- Servico: termoEpiService (fetchTermoEpiContext) usando dataClient (Supabase ou local).
- Utils: TermoEpiUtils (download PDF via httpClient) e template compartilhado `shared/documents/epiTermTemplate.js`.
- Erros: logError com page 'termo-epi' registra falhas de geracao e download em app_errors.

Fluxos

- Formulario: matricula ou nome (obrigatorio informar um), periodo opcional (dataInicio/dataFim). Valida datas (formato e ordem).
- Gerar termo: busca contexto via service, monta HTML pelo template e mostra preview em iframe.
- Download: gera PDF a partir do HTML e contexto via proxy /api/supabase (cookie HttpOnly); mostra erro em caso de falha.
- Resumo: exibe colaborador, centro de servico, ultima entrega, itens entregues e origem dos dados (local ou Supabase).

Boas praticas

- Validar datas antes de chamar o service; informar pelo menos matricula ou nome.
- Exibir mensagens de erro no preview e registrar no log para acompanhar falhas de PDF ou carga.

Atualizacao 2025-12

- Tela refatorada com hook/service/utils; logging de erros adicionado; preview e download separados por estado isLoading/isDownloading.

Atualizacao 2026-02

- Download do PDF agora usa httpClient para aplicar envelope de erro e request_id das Functions.
- A Edge Function `termo-epi` passou a exigir Authorization Bearer JWT; hoje o proxy backend injeta o token a partir do cookie HttpOnly.
- Preview HTML passou a ser sanitizado e exibido em iframe sandbox.
- Modo trusted (templates internos) usa allow-same-origin para auto-resize; modo untrusted usa sandbox vazio com scroll.
- Sanitizacao preserva documento completo e estilos (head/style/class/id) para manter o layout da pre-visualizacao.
- Sanitizacao registra eventos de seguranca (script, event_handler, javascript_url, iframe) em app_errors com tenant_hint quando ha remocao.
- Edge Function termo-epi registra eventos de seguranca (api_errors) quando HTML suspeito e enviado.
- Preview envia contexto (page/tenant_hint/user_id) para log de seguranca.
- Rate limit: edge function `termo-epi` limita 1 requisicao por tenant a cada 60 segundos (tabela edge_rate_limits).
- Rate limit diario: plano define limite de PDF (limit_pdf_daily). Conta apenas sucesso; 3 falhas no dia bloqueiam ate meia-noite (America/Sao_Paulo).
- Observabilidade: falhas nos RPCs diarios (`edge_rate_limit_daily_check` / `edge_rate_limit_daily_register`) geram log em `api_errors` com code DAILY_LIMIT_*.
- Reset manual (teste): limpar consumo diario do tenant atual:
```
delete from public.edge_rate_limits_daily
where account_owner_id = '<OWNER_ID>'
  and day_date = (now() at time zone 'America/Sao_Paulo')::date;
```
- Arquivos alterados:
- `src/utils/TermoEpiUtils.js`
- `supabase/functions/termo-epi/index.ts`
- `src/components/AutoResizeIframe.jsx`
- `src/pages/TermosEpiPage.jsx`
- `src/components/Documents/TermoEpiPreviewModal.jsx`
- `src/services/errorLogService.js`
- Antes/Depois:
- Antes: download usava fetch direto e tratava erro manualmente.
- Depois: download usa httpClient com responseType blob e envelope padronizado.

Atualizacao 2026-03 (Seguranca)
-------------------------------
- Download de PDF passa pelo proxy `/api/supabase/functions/v1`, sem Authorization no frontend.
- Cookie HttpOnly passou a ser a fonte de autenticacao; tokens nao ficam acessiveis no JS.
- Arquivos alterados:
- `src/utils/TermoEpiUtils.js`

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- TermosEpiPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/TermosEpiPage.jsx
  - Responsavel por: orquestrar formulario, preview e download consumindo o hook de termo.
- useTermoEpi
  - Tipo: hook de formulario/preview
  - Caminho: src/hooks/useTermoEpi.js
  - Responsavel por: estado do formulario, validacao de datas, carga de contexto, geracao de HTML e download de PDF; controla isLoading/isDownloading.

Constantes e configuracoes
--------------------------
- INITIAL_FORM / INITIAL_PREVIEW
  - Tipo: estados iniciais
  - Caminho: src/hooks/useTermoEpi.js
  - Uso: reset de formulario e preview.

Funcoes utilitarias relacionadas
--------------------------------
- buildEpiTermHtml
  - Tipo: template de documento
  - Caminho: shared/documents/epiTermTemplate.js
  - Responsavel por: montar HTML do termo com base no contexto carregado.
- downloadTermoEpiPdf
  - Tipo: utilitario de download
  - Caminho: src/utils/TermoEpiUtils.js
  - Responsavel por: gerar/baixar PDF a partir do HTML e contexto via httpClient.

Servicos e integracoes externas
-------------------------------
- termoEpiService.fetchTermoEpiContext
  - Tipo: servico de API
  - Caminho: src/services/termoEpiService.js
  - Responsavel por: buscar contexto do termo (via dataClient/Supabase ou local) a partir de matricula/nome e periodo.
- Supabase Functions (renderizacao PDF)
  - Tipo: integracao externa
  - Caminho: supabase/functions/termo-epi
  - Responsavel por: renderizar PDF; autenticacao via proxy /api/supabase e cookie HttpOnly.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpContent.json (chave 'termoEpi'); edite ali para ajustar titulos/steps/notes.
- Para imagens, salve em public/help/termoEpi/ e aponte no campo 'media' do passo (ex.: /help/termoEpi/exemplo.webp).

