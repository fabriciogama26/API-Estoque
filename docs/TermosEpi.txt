Tela: Termo de EPI

Visao geral

Gerar e baixar o termo de responsabilidade de EPI para colaboradores, com pre-visualizacao HTML e PDF renderizado no cliente.

Arquitetura (modular)

- Hook useTermoEpi: controla formulario, validacao, carga do contexto, preview HTML e download do PDF.
- Servico: termoEpiService (fetchTermoEpiContext) usando dataClient (Supabase ou local).
- Utils: TermoEpiUtils (download PDF via httpClient) e template compartilhado `shared/documents/epiTermTemplate.js`.
- Erros: logError com page 'termo-epi' registra falhas de geracao e download em app_errors.

Fluxos

- Formulario: matricula ou nome (obrigatorio informar um), periodo opcional (dataInicio/dataFim). Valida datas (formato e ordem).
- Gerar termo: busca contexto via service, monta HTML pelo template e mostra preview em iframe.
- Download: gera PDF a partir do HTML e contexto; mostra erro em caso de falha.
- Resumo: exibe colaborador, centro de servico, ultima entrega, itens entregues e origem dos dados (local ou Supabase).

Boas praticas

- Validar datas antes de chamar o service; informar pelo menos matricula ou nome.
- Exibir mensagens de erro no preview e registrar no log para acompanhar falhas de PDF ou carga.

Atualizacao 2025-12

- Tela refatorada com hook/service/utils; logging de erros adicionado; preview e download separados por estado isLoading/isDownloading.

Atualizacao 2026-02

- Download do PDF agora usa httpClient para aplicar envelope de erro e request_id das Functions.
- Arquivos alterados:
- `src/utils/TermoEpiUtils.js`
- Antes/Depois:
- Antes: download usava fetch direto e tratava erro manualmente.
- Depois: download usa httpClient com responseType blob e envelope padronizado.

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- TermosEpiPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/TermosEpiPage.jsx
  - Responsavel por: orquestrar formulario, preview e download consumindo o hook de termo.
- useTermoEpi
  - Tipo: hook de formulario/preview
  - Caminho: src/hooks/useTermoEpi.js
  - Responsavel por: estado do formulario, validacao de datas, carga de contexto, geracao de HTML e download de PDF; controla isLoading/isDownloading.

Constantes e configuracoes
--------------------------
- INITIAL_FORM / INITIAL_PREVIEW
  - Tipo: estados iniciais
  - Caminho: src/hooks/useTermoEpi.js
  - Uso: reset de formulario e preview.

Funcoes utilitarias relacionadas
--------------------------------
- buildEpiTermHtml
  - Tipo: template de documento
  - Caminho: shared/documents/epiTermTemplate.js
  - Responsavel por: montar HTML do termo com base no contexto carregado.
- downloadTermoEpiPdf
  - Tipo: utilitario de download
  - Caminho: src/utils/TermoEpiUtils.js
  - Responsavel por: gerar/baixar PDF a partir do HTML e contexto via httpClient.

Servicos e integracoes externas
-------------------------------
- termoEpiService.fetchTermoEpiContext
  - Tipo: servico de API
  - Caminho: src/services/termoEpiService.js
  - Responsavel por: buscar contexto do termo (via dataClient/Supabase ou local) a partir de matricula/nome e periodo.

Ajuda contextual
----------------
- Botao 'Ajuda' no cabecalho abre modal com passos e notas desta pagina.
- Conteudo vem de src/help/helpContent.json (chave 'termoEpi'); edite ali para ajustar titulos/steps/notes.
- Para imagens, salve em public/help/termoEpi/ e aponte no campo 'media' do passo (ex.: /help/termoEpi/exemplo.webp).

