Guia de Configuração e Validação de RLS
=======================================

Contexto
--------
O projeto utiliza Row Level Security (RLS) para controlar acesso às tabelas principais (materiais, pessoas, entradas, saídas, acidentes) e catálogos auxiliares. Este guia resume onde as políticas são definidas e como validá-las após o deploy.

Habilitando RLS
---------------
- A migration `0002_enable_rls.sql` liga o RLS nas tabelas base e cria políticas mínimas: leitura para `authenticated`, escrita restrita ao `service_role` (para seeds/funções). A política `app_users read own` agora compara `auth.uid() = id`, refletindo o novo formato da tabela.【F:supabase/migrations/0002_enable_rls.sql†L1-L38】
- Migration `0009_allow_authenticated_writes.sql` expande permissões permitindo `INSERT/UPDATE` para usuários autenticados em `entradas`, `saidas` e `acidentes` (necessário para o frontend).【F:supabase/migrations/0009_allow_authenticated_writes.sql†L1-L72】
- Tabelas de referência (`grupos_material`, `acidente_locais`, etc.) têm RLS habilitado e leitura liberada para `authenticated`/`anon`, mantendo manutenção apenas com `service_role`.【F:supabase/migrations/0013_rls_reference_tables.sql†L1-L36】

Checklist pós-deploy
--------------------
1. Execute `select * from pg_policies where schemaname = 'public' order by tablename, policyname;` para confirmar políticas criadas.
2. Com um usuário autenticado (`supabase.auth.signInWithPassword`), teste operações CRUD:
   - `select` em `materiais`, `pessoas`, `entradas`, `saidas`, `acidentes`.
   - `insert` em `entradas`, `saidas`, `acidentes` (deve funcionar).
   - `update` em `materiais` apenas para campos permitidos pelas funções/rotinas (ex.: `estoque_minimo` via frontend).
3. Verifique se views e funções expostas (ex.: `vw_indicadores_acidentes`) estão definidas como `security definer` quando necessário e usam roles adequadas.

Boas práticas
-------------
- Qualquer nova tabela deve habilitar RLS e replicar o padrão (leitura para `authenticated`, escrita opcional). Crie migrations específicas para evitar alteração manual via Studio.
- Use `supabase migration new add_policy_<tabela>` para versionar alterações de política.
- Documente exceções (ex.: endpoints públicos) e valide periodicamente com `supabase db pull` para garantir sincronismo entre ambientes.


Atualizacao 2025-11
--------------------
- Esclareci que `api.estoque.dashboard` passou a consultar `saidas.centro_servico` e `materiais.fabricanteNome`; confirme que as RLS existentes permitem leitura agregada desses campos.
- Inclui recomendacao para adicionar testes de RLS cobrindo a rota `dashboard` quando novos filtros clicaveis forem expostos para perfis restritos.
Atualizacao 2025-12 (RLS)
-------------------------
- Use (select auth.role()) e (select auth.uid()) nas policies para evitar alerta auth_rls_initplan.
- Evite recursao: nao consulte app_users dentro das policies de app_users; prefira claims no JWT ou service_role para operacoes administrativas.
- Remova roles extras (anon/authenticator/cli/dashboard_user) das policies; mantenha so authenticated/service_role salvo excecoes documentadas.
Atualizacao 2025-12 (dependentes/configuracoes)
---------------------------------------------
- Configuracoes: autocomplete traz app_users e app_users_dependentes; master visivel para admin/master.
- Policies: preferir authenticated/service_role; avoid recursao (use claims ou service_role).
