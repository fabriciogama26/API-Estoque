Guia de Configuração e Validação de RLS
=======================================

Contexto
--------
O frontend acessa o Supabase diretamente via `@supabase/supabase-js`, usando tokens emitidos para usuários autenticados. Todas as tabelas expostas ao cliente devem ter Row Level Security (RLS) habilitado, garantindo que cada usuário enxergue apenas os dados permitidos. Funções serverless em `api/` são opcionais, mas quando utilizadas devem operar com a chave `service_role` e respeitar políticas específicas.

Tabelas principais
------------------
Recomendações gerais:
- **pessoas:**
  - `SELECT`: permitir `auth.role() = 'authenticated'`.
  - `INSERT` / `UPDATE`: restringir a perfis administrativos (claims como `is_admin` ou associação em tabela de permissões).
- **materiais:**
  - `SELECT`: liberar para usuários autenticados.
  - `INSERT` / `UPDATE`: permitir apenas quando o usuário possuir claim apropriada (por exemplo `auth.jwt()->>'can_manage_materials' = 'true'`).
- **material_price_history:**
  - `SELECT`: liberar para auditoria.
  - `INSERT`: permitir apenas para a função serverless ou claims administrativas (verifique `request.jwt.claim.role`).
- **entradas** e **saidas:**
  - `SELECT`: usuários autenticados.
  - `INSERT`: apenas operadores de estoque; uma tabela auxiliar (`operadores_estoque`) pode relacionar `user_id` com permissão.
- **acidentes:**
  - `SELECT`: equipe de SST autenticada.
  - `INSERT` / `UPDATE`: limitar a perfis autorizados (claims ou associação em tabela dedicada).
- **tabelas de domínio (centros, cargos, agentes etc.):**
  - Geralmente leitura aberta para `authenticated`; escrituras podem ser limitadas a administradores.

Criando políticas
-----------------
Exemplos de comandos úteis:
```sql
-- Habilitar RLS
alter table pessoas enable row level security;

-- Política de leitura genérica
create policy "pessoas_select_authenticated" on pessoas
for select using (auth.role() = 'authenticated');

-- Política de escrita condicionada por claim
create policy "pessoas_update_admins" on pessoas
for update using (
  auth.role() = 'authenticated'
  and coalesce((auth.jwt()->>'is_admin')::bool, false)
);

-- Política baseada em tabela auxiliar
create policy "entradas_operadores" on entradas
for insert using (
  auth.role() = 'authenticated'
  and exists (
    select 1 from operadores_estoque oe
    where oe.user_id = auth.uid()
  )
);
```

Validação contínua
------------------
- **Testes automatizados:**
  - Utilize Supabase CLI com tokens simulados ou `pgTAP` para validar políticas em pipelines.
- **Testes manuais:**
  - Gere tokens com `supabase.auth.signInWithPassword` para diferentes perfis e execute consultas usando `curl`/Postman.
  - Confirme que operações sem permissão retornam 401/403.
- **Auditoria:**
  - Consulte políticas ativas com `select * from pg_policies where schemaname = 'public';`.
  - Verifique periodicamente se novas tabelas foram criadas sem RLS habilitado.

Integração com funções serverless (opcional)
-------------------------------------------
- Quando usar `service_role`, adicione políticas específicas permitindo operações com `auth.role() = 'service_role'`.
- Nunca exponha a chave `service_role` ao frontend; mantenha-a apenas nas funções em `api/` ou na infraestrutura de deploy.
- Se precisar executar operações privilegiadas (ex.: gerar relatórios agregados), considere criar RPCs ou views com políticas dedicadas.

Checklist de implantação
------------------------
1. Certifique-se de que todas as tabelas acessadas pelo aplicativo tenham RLS habilitado.
2. Crie políticas de leitura/escrita condizentes com os perfis existentes.
3. Execute testes de autorização antes de cada deploy.
4. Documente ajustes relevantes neste diretório (`docs/`).

Referências
-----------
- [Supabase RLS](https://supabase.com/docs/guides/auth/row-level-security)
- [Claims personalizados](https://supabase.com/docs/guides/auth/custom-claims)
- [Supabase CLI](https://supabase.com/docs/guides/cli)
