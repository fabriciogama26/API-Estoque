Guia de Estrutura Supabase
==========================

Objetivo
--------
Checklist rÃ¡pido para garantir que o schema do Supabase estÃ¡ alinhado com o esperado pelo frontend e funÃ§Ãµes auxiliares.

PrÃ©-requisitos
--------------
- ExtensÃµes `uuid-ossp` e `pgcrypto` habilitadas (inclusas nas migrations iniciais).
- Todas as migrations aplicadas atÃ© `0027_expand_material_history.sql` (ver `supabase/README.md`).ã€F:supabase/README.mdâ€ L12-L55ã€‘
- RLS ativo nas tabelas acessadas pelo aplicativo (consultar [`docs/rls-policies-guide.txt`](rls-policies-guide.txt)).

Tabelas principais
------------------
- **app_users**: mapeia usuÃ¡rios do Auth (`id` = mesmo UUID de `auth.users`, `username`, `display_name`). Opcional para perfis internos.ã€F:supabase/README.mdâ€ L12-L55ã€‘
- **pessoas + pessoas_historico**: dados cadastrais (centro de serviÃ§o, cargo, setor, tipo de execuÃ§Ã£o, datas) e auditoria de mudanÃ§as.ã€F:supabase/README.mdâ€ L12-L55ã€‘
- **materiais + material_price_history**: cadastro de EPIs com estoque mÃ­nimo, CA, valor unitÃ¡rio e histÃ³rico de preÃ§o.ã€F:supabase/README.mdâ€ L12-L55ã€‘
- **entradas / saidas**: movimentaÃ§Ã£o de estoque com campos de auditoria (`usuarioResponsavel`, datas).ã€F:supabase/README.mdâ€ L12-L55ã€‘
- **acidentes + acidente_historico**: registros completos de SST com vÃ­nculo a agentes, tipos, partes e lesÃµes.ã€F:supabase/README.mdâ€ L12-L55ã€‘
- Colunas recentes: `ativo boolean default true` e `cancel_motivo` (texto/nullable) para cancelamento; HHT nao é salvo no acidente (dashboard cruza com hht_mensal).

Tabelas de referÃªncia
---------------------
- **CatÃ¡logos operacionais**: `centros_servico`, `setores`, `cargos`, `centros_custo`, `tipo_execucao`.
- **CatÃ¡logos de acidentes**: `acidente_agentes`, `acidente_tipos`, `acidente_partes`, `acidente_lesoes`.
- **CatÃ¡logo de materiais**: `grupos_material`, `grupos_material_itens`, `grupos_material_cor`, `grupos_material_caracteristica_epi`.
- Todas devem ter RLS habilitado e polÃ­ticas de leitura para `authenticated` (ver migration `0013_rls_reference_tables.sql`).ã€F:supabase/migrations/0013_rls_reference_tables.sqlâ€ L1-L36ã€‘

Views e suportes
----------------
- `vw_indicadores_acidentes`: alimenta o dashboard de acidentes (resumo, tendência e distribuições por tipo/agente/cargo/parte/lesão). Calcula TF/TG via hht_mensal por centro/mês e filtra acidentes `ativo=true`. Certifique-se de atualizar ao alterar o schema.Æ??F:src/pages/DashboardAcidentes.jsxƒ?ÿL81-L229Æ?
- Outras views podem ser adicionadas para relatÃ³rios, desde que respeitem RLS.

Checklist de validaÃ§Ã£o
----------------------
- [ ] `supabase db status` sem migrations pendentes.
- [ ] UsuÃ¡rio autenticado consegue listar/cadastrar pessoas, materiais, entradas, saÃ­das e acidentes no frontend.
- [ ] Dashboards retornam dados (estoque + acidentes) apÃ³s aplicar seeds ou inserir registros reais.ã€F:src/pages/DashboardPage.jsxâ€ L113-L213ã€‘ã€F:src/pages/DashboardAcidentes.jsxâ€ L81-L193ã€‘
- [ ] Termo de EPI encontra colaboradores e saÃ­das (ver [`docs/TermosEpi.txt`](TermosEpi.txt)).
- [ ] PolÃ­ticas RLS revisadas e testadas com diferentes perfis.
- [ ] Seeds de desenvolvimento (`0003_seed_sample_data.sql`) nÃ£o executam em produÃ§Ã£o.ã€F:supabase/README.mdâ€ L37-L55ã€‘

Links Ãºteis
-----------
- [`supabase/README.md`](../supabase/README.md)
- [`docs/stateless-supabase-notes.txt`](stateless-supabase-notes.txt)
- [`docs/rls-policies-guide.txt`](rls-policies-guide.txt)


Atualizacao 2025-11
--------------------
- Acrescentei itens para verificar a presenca de `fabricante_nome` e `centro_servico` legiveis nas views utilizadas pelo dashboard.
- Recomendei revisar indices nas colunas usadas pelos filtros clicaveis para manter as agregacoes responsivas.
Atualizacao 2025-12 (credenciais/dependentes)
-------------------------------------------
- app_credentials_catalog deve existir com seeds (admin/master/operador/estagiario/visitante); RLS: leitura para authenticated/service_role e escrita apenas service_role.
- app_users.credential e app_users_dependentes.credential sao UUID com FK para o catalogo; dependentes herdam do titular quando credential estiver vazia.
- app_users_credential_history referencia o catalogo (before/after) com RLS para authenticated/service_role.
- Evite policies que consultam app_users dentro da propria policy (previne recursao); prefira claims no JWT ou service_role para administradores.
Atualizacao 2025-12 (configuracoes/dependentes)
--------------------------------------------
- Check de RLS: autocomplete deve ler app_users e app_users_dependentes (policies para authenticated/service_role) e master deve aparecer para admin/master.
- Conferir seeds do catalogo de credenciais e FKs UUID em app_users/app_users_dependentes/app_users_credential_history.

