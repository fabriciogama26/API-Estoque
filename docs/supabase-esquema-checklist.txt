Guia de Estrutura Supabase
==========================

Objetivo
--------
Checklist rápido para garantir que o schema do Supabase está alinhado com o esperado pelo frontend e funções auxiliares.

Pré-requisitos
--------------
- Extensões `uuid-ossp` e `pgcrypto` habilitadas (inclusas nas migrations iniciais).
- Todas as migrations aplicadas até `0027_expand_material_history.sql` (ver `supabase/README.md`).【F:supabase/README.md†L12-L55】
- RLS ativo nas tabelas acessadas pelo aplicativo (consultar [`docs/rls-policies-guide.txt`](rls-policies-guide.txt)).

Tabelas principais
------------------
- **app_users**: mapeia usuários do Auth (`auth_user_id`, `username`, `display_name`). Opcional para perfis internos.【F:supabase/README.md†L12-L55】
- **pessoas + pessoas_historico**: dados cadastrais (centro de serviço, cargo, setor, tipo de execução, datas) e auditoria de mudanças.【F:supabase/README.md†L12-L55】
- **materiais + material_price_history**: cadastro de EPIs com estoque mínimo, CA, valor unitário e histórico de preço.【F:supabase/README.md†L12-L55】
- **entradas / saidas**: movimentação de estoque com campos de auditoria (`usuarioResponsavel`, datas).【F:supabase/README.md†L12-L55】
- **acidentes + acidente_historico**: registros completos de SST com vínculo a agentes, tipos, partes e lesões.【F:supabase/README.md†L12-L55】

Tabelas de referência
---------------------
- **Catálogos operacionais**: `centros_servico`, `setores`, `cargos`, `centros_custo`, `tipo_execucao`.
- **Catálogos de acidentes**: `acidente_agentes`, `acidente_tipos`, `acidente_partes`, `acidente_lesoes`.
- **Catálogo de materiais**: `grupos_material`, `grupos_material_itens`, `grupos_material_cor`, `grupos_material_caracteristica_epi`.
- Todas devem ter RLS habilitado e políticas de leitura para `authenticated` (ver migration `0013_rls_reference_tables.sql`).【F:supabase/migrations/0013_rls_reference_tables.sql†L1-L36】

Views e suportes
----------------
- `vw_indicadores_acidentes`: alimenta o dashboard de acidentes (resumo, tendência, distribuições por tipo/agente/cargo/parte). Certifique-se de atualizar ao alterar o schema.【F:src/pages/DashboardAcidentes.jsx†L81-L152】
- Outras views podem ser adicionadas para relatórios, desde que respeitem RLS.

Checklist de validação
----------------------
- [ ] `supabase db status` sem migrations pendentes.
- [ ] Usuário autenticado consegue listar/cadastrar pessoas, materiais, entradas, saídas e acidentes no frontend.
- [ ] Dashboards retornam dados (estoque + acidentes) após aplicar seeds ou inserir registros reais.【F:src/pages/DashboardPage.jsx†L113-L213】【F:src/pages/DashboardAcidentes.jsx†L81-L193】
- [ ] Termo de EPI encontra colaboradores e saídas (ver [`docs/TermosEpi.txt`](TermosEpi.txt)).
- [ ] Políticas RLS revisadas e testadas com diferentes perfis.
- [ ] Seeds de desenvolvimento (`0003_seed_sample_data.sql`) não executam em produção.【F:supabase/README.md†L37-L55】

Links úteis
-----------
- [`supabase/README.md`](../supabase/README.md)
- [`docs/stateless-supabase-notes.txt`](stateless-supabase-notes.txt)
- [`docs/rls-policies-guide.txt`](rls-policies-guide.txt)


Atualizacao 2025-11
--------------------
- Acrescentei itens para verificar a presenca de `fabricante_nome` e `centro_servico` legiveis nas views utilizadas pelo dashboard.
- Recomendei revisar indices nas colunas usadas pelos filtros clicaveis para manter as agregacoes responsivas.
