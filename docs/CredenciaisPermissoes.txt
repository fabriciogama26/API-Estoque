Credenciais e permissoes
========================

Visao geral
-----------
O sistema controla acesso por:
- Autenticacao (Supabase Auth)
- Credencial (perfil/role)
- Permissoes de pagina (lista de pageId)

O usuario logado pode ser:
- Titular (registro em public.app_users)
- Dependente (registro em public.app_users_dependentes), herdando configuracoes do titular quando aplicavel


Mapa de codigo (frontend)
------------------------
- PermissionsProvider: `src/context/PermissionsContext.jsx`
  - Carrega credential/page_permissions (titular ou dependente)
  - Calcula `canAccessPath()` e `allowedPaths`
- effectiveUserService: `src/services/effectiveUserService.js`
  - Resolve credencial efetiva (heranca para dependentes)
  - Mapeia credential UUID <-> id_text do catalogo
- ProtectedRoute: `src/components/ProtectedRoute.jsx`
  - Bloqueia rotas sem autenticacao/permissao e redireciona para `/sem-acesso`
- NavBar: `src/components/NavBar.jsx`
  - Oculta itens de menu conforme `canAccessPath`
- NoAccessPage: `src/pages/NoAccessPage.jsx`
  - Pagina exibida quando o usuario nao tem acesso
- Configuracoes (permissoes e reset de senha): `src/pages/Configuracoes.jsx`


Constantes e configuracoes
--------------------------
- Catalogo de paginas (pageId -> path): `src/config/permissions.js` (`PAGE_CATALOG`)
- Permissoes padrao por credencial: `src/config/permissions.js` (`DEFAULT_CREDENTIAL_PERMISSIONS`)


Modelo de dados (Supabase)
--------------------------
- Titulares: `public.app_users`
  - `id` (uuid) deve ser o mesmo UUID do `auth.users.id`
  - `credential` (uuid -> `app_credentials_catalog.id`)
  - `page_permissions` (text[] com pageId)

- Dependentes: `public.app_users_dependentes`
  - `auth_user_id` (uuid do `auth.users.id` do dependente)
  - `owner_app_user_id` (uuid do titular em `app_users.id`)
  - `credential` e `page_permissions` podem herdar do titular quando vazios
  - `ativo` controla se o dependente pode logar/usar o sistema

- Catalogo de credenciais: `public.app_credentials_catalog`
  - `id` (uuid), `id_text` (ex.: admin/operador), `label`, `level` (hierarquia)

- Auditoria de mudancas: `public.app_users_credential_history`
  - Guarda before/after de credencial/permissoes e a acao (`update`/`password_reset`)
  - Inclui `target_auth_user_id` (para historico de dependentes e titulares)


Boas praticas
-------------
- Sempre garantir que `public.app_users.id` = `auth.users.id` para titulares.
- Manter `PAGE_CATALOG` e `DEFAULT_CREDENTIAL_PERMISSIONS` atualizados ao criar novas telas.
- Proteger rotas (ProtectedRoute) e esconder menu (NavBar) nao substitui validacao no backend:
  operacoes sensiveis devem ser validadas no Supabase (RLS/RPC/Edge Functions) quando possivel.

