Credenciais e Permissoes
========================

Mapa de Codigo (funcoes, hooks e constantes)
--------------------------------------------
- PermissionsProvider (src/context/PermissionsContext.jsx): carrega credential/page_permissions via Supabase (titular ou dependente), usa effectiveUserService para resolver credential_text/UUID e calcula canAccessPath/allowedPaths.
- effectiveUserService (src/services/effectiveUserService.js): mapeia credential UUID<->id_text do catalogo, resolve heranca de dependentes (credential/status/paginas) e expÃµe credential_text/credentialId.
- ProtectedRoute (src/components/ProtectedRoute.jsx): valida autenticacao/permissao e redireciona para /sem-acesso.
- NavBar (src/components/NavBar.jsx): oculta itens de menu conforme canAccessPath.
- SystemStatus (src/components/SystemStatus.jsx): mostra nome/credencial e atalho para Configuracoes.
- NoAccessPage (src/pages/NoAccessPage.jsx): pagina de acesso negado.
- ConfiguracoesPage / PermissionsSection (src/pages/Configuracoes.jsx): lista titulares + dependentes, edita credential/page_permissions/status e abre historico (usa target_auth_user_id e owner_app_user_id para dependentes).
- AdminResetPasswordSection (src/pages/Configuracoes.jsx): envia reset de senha para titulares ou dependentes.

Constantes e configuracoes
--------------------------
- PAGE_CATALOG: ids -> rotas (src/config/permissions.js).
- DEFAULT_CREDENTIAL_PERMISSIONS: fallback de paginas por credencial (src/config/permissions.js).
- CREDENTIAL_OPTIONS: opcoes de UI, filtradas por hierarquia (level); master so aparece para quem ja e master.

Fluxo de dados
--------------
- Banco: app_users (titulares) e app_users_dependentes (dependentes) usam credential UUID com FK para app_credentials_catalog (id + id_text + level) e page_permissions (text[]).
- Historico: app_users_credential_history (migrations 0063/0068/0070/0074) guarda before/after de credential/page_permissions, acao (`update` ou `password_reset`), target_auth_user_id (login titular/dependente) e owner_app_user_id/target_dependent_id para dependentes.
- Carregamento: PermissionsProvider resolve usuario efetivo (heranca de titular para dependente) e mescla com metadata do auth; modo local cai em admin.
- Navegacao: ProtectedRoute bloqueia quando canAccessPath = false; NavBar filtra itens; SystemStatus usa canAccessPath('/configuracoes').
- Edicao: Configuracoes usa autocomplete (app_users + app_users_dependentes), filtra credenciais por level (admin nao ve master), salva em app_users ou app_users_dependentes e registra historico; sincroniza banimento via RPC sync_user_ban_with_status.
- Reset de senha (admin/master): envia reset via supabase.auth.resetPasswordForEmail e registra historico (action password_reset).

Credenciais padrao (catalogo)
-----------------------------
- master (level maximo): todas as paginas; visivel apenas para usuarios master.
- admin: todas as paginas.
- operador: dashboards, estoque, entradas, saidas, cadastros, acidentes, termo, configuracoes, no-access.
- estagiario: dashboards, termo, no-access.
- visitante: dashboards, termo, no-access.

Como adicionar nova credencial
------------------------------
1) Catalogo: inserir em app_credentials_catalog (id_text, label, description, level coerente com a hierarquia).
2) Frontend: adicionar em CREDENTIAL_OPTIONS e DEFAULT_CREDENTIAL_PERMISSIONS (usar pageIds do PAGE_CATALOG); ajustar describeCredential se preciso.
3) Policies/RLS: validar se o level permite leitura/edicao (ex.: somente level <= current_user_level); service_role segue liberado.
4) Testar: login com a credencial nova (titular ou dependente), conferir menu/rotas e historico.

UI de permissoes
----------------
- Autocomplete de usuario/dependente com filtro por level; master nao aparece para quem nao e master.
- Toggles de paginas em duas colunas; status ativo/inativo so master/admin podem alterar.
- Reset de senha (admin/master) envia email e grava historico.

Seguranca (RLS)
---------------
- app_credentials_catalog: select para authenticated/service_role; all para service_role; pode filtrar por level <= current_credential_level().
- app_users e app_users_dependentes: ler/editar apenas quando o level do alvo <= level do usuario logado; service_role liberado. Evitar policies recursivas; use funcao helper que captura auth.uid() uma unica vez.
- app_users_credential_history: select para authenticated/service_role; insert quando authenticated agir sobre si (changed_by = auth.uid()) ou service_role.

PageIds disponiveis (PAGE_CATALOG)
----------------------------------
- dashboard -> ['/', '/dashboard']
- dashboard-acidentes -> ['/dashboard/acidentes']
- estoque -> ['/estoque']
- entradas -> ['/entradas', '/movimentacoes/entradas']
- saidas -> ['/saidas', '/movimentacoes/saidas']
- cadastros-pessoas -> ['/cadastros/pessoas']
- cadastros-materiais -> ['/cadastros/materiais']
- acidentes-cadastro -> ['/acidentes/cadastro']
- termo-epi -> ['/documentos/termo-epi', '/termos/epi']
- configuracoes -> ['/configuracoes']
- no-access -> ['/sem-acesso']

Notas rapidas
-------------
- Valores em page_permissions prevalecem sobre o default quando nao vazios.
- Modo local (VITE_DATA_MODE=local) trata todos como admin e ignora Supabase.
- Master enxerga/edita tudo; admins nao veem nem editam credenciais de level maior (ex.: master).
