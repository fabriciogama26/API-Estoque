Credenciais e permissões (RBAC + owner)

=======================================



Resumo

------

- Usuários (titular + dependentes) em `app_users` com `parent_user_id` e `perm_version`.

- RBAC padrão: `roles`, `permissions`, `role_permissions`, `user_roles`, `user_permission_overrides`.

- Escopo por conta: `account_owner_id` em tabelas de negócio; RLS libera apenas dados do owner (`my_owner_id()`).

- Helpers: `my_owner_id()` resolve o titular; `has_permission(key)` = override deny > override allow > role_permissions (sem legado credential master).

- Visão `/me`: `public.v_me` traz `owner_id`, `roles`, `permissions[]`, `perm_version`, `is_master` (somente role master).

- Front usa `PermissionsContext` + `permissions.js` para mapear rotas, menus e toggles.



Modelo de dados (Supabase)

--------------------------

**Perfis**

- `public.app_users`: `id` = `auth.users.id`; `parent_user_id` (null se titular); `perm_version`; `ativo`.

- `public.app_users_dependentes`: legado; trigger mantém sincronizado em `app_users`.

- Índice/constraint: FK `parent_user_id` -> `app_users(id)` e índice em `parent_user_id`.



**RBAC**

- `public.roles` (id, name).

- `public.permissions` (id, key, description).

- `public.role_permissions` (role_id, permission_id) PK composto.

- `public.user_roles` (user_id, role_id, scope_parent_user_id default 0000...). PK composto.

- `public.user_permission_overrides` (user_id, permission_key, allowed) PK composto.

- Seeds de roles: `master`, `admin`, `supervisor`, `viewer`, `owner`, `operador`, `estagiario`, `visitante`.

- Seeds de permissions: `estoque.read|write`, `pessoas.read|write`, `acidentes.read|write`, `hht.read|write`,
  `estoque.dashboard`, `dashboard_analise_estoque`, `acidentes.dashboard`, `estoque.atual`, `estoque.entradas`,
  `estoque.saidas`, `estoque.materiais`, `estoque.termo`, `estoque.relatorio`, `estoque.reprocessar`,
  `rbac.manage`, `users.manage`, `credentials.manage`.

- Mapeamentos principais:

  - master: todas as permissions (somente via role master).

  - admin/owner: todas as permissions seed (inclui rbac/users/credentials.manage e estoque.reprocessar).

  - supervisor/viewer: leituras (hht.read, estoque.read, pessoas.read, acidentes.read).

  - operador: estoque.read/write + pessoas.read + acidentes.read + hht.read.

  - estagiario: leituras básicas (estoque.read, pessoas.read, acidentes.read, hht.read).

  - visitante: estoque.read.

  - Override por usuário: deny > allow > role.



**Helpers**

- `public.my_owner_id(p_user_id default auth.uid())`: retorna o titular (se dependente, devolve `parent_user_id`, senão o próprio id).

- `public.has_permission(key, p_user_id default auth.uid())`: override deny > override allow > role_permissions; sem legado credential master.

- `public.resolve_user_permissions(p_user_id)`: array de keys efetivas; master apenas se usuário tiver role master.



**Auditoria**

- `public.app_users_credential_history`: log de altera??es (roles/perms/reset). Campos: user_id (owner), target_auth_user_id, owner_app_user_id, target_dependent_id, user_username (alvo), changed_by/_username (autor), action (`role_update`/`password_reset`), before/after (permissions array), timestamps.

- Triggers de perm_version: em `user_roles` e `user_permission_overrides` (função `bump_perm_version`).



**Conta/owner e RLS**

- `account_owner_id` em tabelas de negócio/catálogos (materiais, entradas, saídas, pessoas, acidentes, hht, catálogos etc.).

- Trigger `set_account_owner_id_default` define `account_owner_id = my_owner_id()` se não vier.

- RLS por domínio (0086): select/insert/update/delete só se `account_owner_id = my_owner_id()` e, para escrita, `has_permission('<dominio>.write')`.

  - Domínios: estoque (materiais/entradas/saídas/etc), pessoas, acidentes, hht, catálogos (estoque.write).

- Gestão de RBAC (0092+): policies de `user_roles`/`user_permission_overrides` exigem `has_permission('rbac.manage')`.

- 0093/0094: master pode gerenciar qualquer owner; admin/owner só dependentes do próprio owner; dependente-admin não pode alterar titular nem atribuir master.



**Visão /me**

- `public.v_me`: `user_id`, `owner_id`, `parent_user_id`, `roles[]`, `permissions[]`, `perm_version`, `is_master` (somente role master).

- Grants: `grant usage on schema public to authenticated; grant select on v_me to authenticated;`.



**Backfills**

- Migration 0089: preenche `account_owner_id` por campos de autor; atribui roles padrão (owner, viewer; master para credential legacy). Após 0092, apenas role master concede acesso total.



Fluxo de uso (frontend)

-----------------------

- Contexto: `src/context/PermissionsContext.jsx`

  - Carrega `v_me` via `/api/permissions/me`; deriva `isMaster` se role master.

  - `allowedPaths`/`canAccessPath` usam `permissions.js` (PAGE_REQUIRED_PERMISSION).

  - `isAdmin`: master ou admin; admin tem todas as rotas liberadas (sem depender de permissions) e ainda filtra usu?rios ao pr?prio owner.



- Configura??es: `src/pages/Configuracoes.jsx`

  - Vis?vel apenas para master/admin.

  - Busca usu?rios: master v? todos; admin v? ele + dependentes (n?o lista masters para n?o-master).

  - Toggles por grupo (`PERMISSION_GROUPS` em `src/config/permissions.js`) ligam chaves combinadas (read/write/dash/termo etc.); role master liga todos.

  - Salvar: remove/insere `user_roles`, aplica overrides (diff vs. role), atualiza ativo, sincroniza ban, grava histórico em `app_users_credential_history`.

  - Histórico: modal estilo histórico de saídas, usando `app_users_credential_history` do usuário.

  - Reset de senha (admin): reusa busca, chama `supabase.auth.resetPasswordForEmail`, registra histórico `password_reset`.



- Navegacao/Rotas:

  - `permissions.js`: `PAGE_CATALOG` e `PAGE_REQUIRED_PERMISSION` (ex.: dashboard -> estoque.dashboard, dashboard-acidentes -> acidentes.dashboard, entradas -> estoque.entradas, saidas -> estoque.saidas, pessoas -> pessoas.write, materiais -> estoque.materiais, termo -> estoque.termo, hht -> hht.write, configuracoes -> rbac.manage).

  - `resolveAllowedPaths`: paths liberados; master ignora checagem.



**Permissoes por pagina (UI)**

- `permissions.js` usa chaves por pagina (ex.: `estoque.atual`, `estoque.relatorio`, `estoque.entradas`).
- RLS continua validando dominios (`estoque.read|write`, `acidentes.read|write` etc). As chaves por pagina servem para menu/rotas.



**scope_parent_user_id**

- Campo existe em `user_roles` mas não é usado; o filtro efetivo é `my_owner_id()` + `account_owner_id`. Se precisar de escopo adicional, alinhar policy e preenchimento.



Como liberar acesso total (master)

----------------------------------

1) Usuário ativo em `app_users` (ou dependente ativo).

2) Inserir em `user_roles` a role `master`.

3) `isMaster` = true somente por role master → menu/rotas liberados, sem depender de permissions[].



Diagnóstico rápido de “Sem permissão”

-------------------------------------

- Checar `/v_me`: roles contém master? permissions contém key da rota (PAGE_REQUIRED_PERMISSION)?
  - Para reprocessamento/forecast manual: conferir `estoque.reprocessar`.
  - Dependente? `parent_user_id` correto?

- RLS escrita negada? Conferir `account_owner_id` vs `my_owner_id()`.

- Salvar credencial: verificar policy `rbac.manage` aplicada, perm rbac.manage, e se alvo não é titular quando ator não é master.



Atualizacao 2026-01 (schema)
-----------------------------
- Arquivos alterados: supabase/migrations/20260228_register_missing_tables.sql.
- Tabelas registradas: public.roles, public.permissions, public.role_permissions, public.user_roles, public.user_permission_overrides.
- Antes/Depois: antes existiam no banco sem migration; depois estao versionadas na pasta supabase/migrations.

Referências de migrations principais

------------------------------------

- 0083: parent_user_id + RBAC tables + has_permission/my_owner_id.

- 0084: account_owner_id columns + triggers.

- 0085: initplan fix em policies de user_roles/overrides.

- 0086: RLS por domínio usando account_owner_id + has_permission; novas perms pessoas/acidentes.

- 0087: perm_version bump + resolve_user_permissions + view v_me.

- 0088: grants v_me + RLS app_errors.

- 0089: backfill account_owner_id + roles padrão (owner/viewer/master).

- 0090: roles adicionais (operador/estagiario/visitante) e mapeamentos.

- 0091: policy para user_roles (estoque.write) [substituída].

- 0092: rbac.manage/users.manage/credentials.manage, policies de gestão, master apenas por role.

- 0093: master pode gerenciar qualquer owner; admin/owner apenas no próprio owner (is_role_master + rbac.manage).

- 0094: dependente-admin não altera titular nem atribui master; alvo precisa ser dependente do mesmo owner, exceto para master.

Resolvido (2026-02)
-------------------
- Chaves por pagina em `permissions.js` (sem estoque.read/write compartilhado).
- PAGE_REQUIRED_PERMISSION atualizado para chaves por pagina.
- Migration adiciona permissoes e mapeia roles para manter comportamento.
- Ver detalhes em docs/PermissoesToggles.txt.

Atualizacao 2026-02 (permissoes)
--------------------------------
- Adicionada a permissao `estoque.reprocessar` para reprocessar previsao mensal por tenant.
- Roles master/admin/owner incluem a nova permissao.
- Arquivos alterados:
- `src/config/permissions.js`
- `supabase/migrations/20260226_add_permission_estoque_reprocessar.sql`
