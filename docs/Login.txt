Tela: Autenticacao (Login e Reset de Senha)

Visao geral

Login com Supabase Auth no modo remoto e modo local (credenciais via .env.local) para desenvolvimento offline. Recuperacao de senha via email e pagina de redefinicao com validacao do link.

Arquitetura (modular)

- Hooks: useLoginForm (estado, submit, recuperacao), useResetPassword (restaura sessao do link, valida senhas, envia update).
- Servicos: authService (resetPasswordForEmail, updateUser, restoreResetSession) usando supabaseClient; errorLogService registra falhas em app_errors.
- Contexto: AuthContext fornece user, login, recoverPassword, logout; suporta persistSession e autoRefresh.

Fluxos

- Login: email + senha; em modo local compara com VITE_LOCAL_USERNAME/PASSWORD; em modo remoto usa supabase.auth.signInWithPassword.
- Login: ao concluir, dispara um /api/session/touch para registrar atividade inicial.
- Recuperacao: envia resetPasswordForEmail com redirect configuravel; feedback de sucesso/erro.
- ResetPasswordPage: valida sessao via getSession/getSessionFromUrl/exchangeCodeForSession/setSession; exige senha >=8 e confirmacao; redireciona ao login apos sucesso.
- ResetPasswordPage: quando nao for expiracao obrigatoria, botao "Voltar ao login" limpa a sessao de recuperacao antes de sair.
- Inatividade: monitora atividade (mouse, teclado, scroll, touch, foco) e envia /api/session/touch; expiracao vem do servidor e o front redireciona ao receber SESSION_EXPIRED.
- Sessao (servidor): valida timebox de 12h e idle de 30min via tabela auth_session_activity; requests com X-User-Interaction atualizam last_seen_at; expiracao retorna 401 com code SESSION_EXPIRED.
- Touch de sessao: front envia POST /api/session/touch com X-User-Interaction e X-Session-Id por login para marcar atividade humana (idle server).
- Reauth: endpoints sensiveis exigem reautenticacao em 15 min; backend responde 403 REAUTH_REQUIRED e o front abre modal para confirmar senha.
- Logout: antes de sair, o front chama /api/session/revoke para registrar revoked_at.
- Expiracao de senha: senha deve ser atualizada a cada 60 dias; fluxo usa /reset-password com sessao ativa.

Boas praticas

- Manter variaveis VITE_SUPABASE_URL/ANON_KEY configuradas; usar redirectTo para reset se necessario.
- Registrar erros (login, recovery, updatePassword, restoreResetSession) em app_errors para auditoria.
- Enviar X-User-Interaction somente em /api/session/touch; evitar polling para nao mascarar idle real.
- Usar X-Session-Id gerado a cada login para criar nova linha de sessao (historico preservado).
- O backend usa X-Session-Id quando enviado; caso contrario, usa session_id do JWT ou hash do token.
- O backend busca sempre a sessao ativa com revoked_at IS NULL e nunca limpa revoked_at ao expirar.
- Se precisar ajustar tempos de sessao, use as envs: SESSION_TIMEBOX_MS, SESSION_IDLE_MS, SESSION_REAUTH_WINDOW_MS, SESSION_TOUCH_THROTTLE_MS.

Atualizacao 2025-12

- Telas modularizadas com hooks/services e logging; compatibilidade com modo local preservada.

Atualizacao 2026-02

- Monitoramento de atividade reforcado (inclui scroll e eventos pointer) e touch de sessao; logout limpa sessao local quando disparado.
- Guard de sessao no backend com timebox/idle e registro em auth_session_activity.
- /api/session/touch + X-Session-Id para marcar atividade; reauth exigida para operacoes sensiveis.
- /api/session/* no front agora usa httpClient para padronizar envelope e request_id.
- Politica de senha: atualizacao a cada 60 dias via metadata password_changed_at.
- Arquivos alterados/criados:
- `supabase/migrations/20260211_auth_session_activity.sql`
- `supabase/migrations/20260213_auth_session_activity_active_index.sql`
- `api/_shared/sessionActivity.js`
- `api/_shared/auth.js`
- `api/_shared/withAuth.js`
- `api/index.js`
- `src/services/sessionService.js`
- `src/context/AuthContext.jsx`
- `src/components/SessionReauthModal.jsx`
- `src/styles/SessionReauthModal.css`
- `src/services/api.js`
- `src/services/authService.js`
- `src/hooks/useChangePassword.js`
- `src/hooks/useResetPassword.js`
- `src/layouts/MainLayout.jsx`
- Antes/Depois:
- Antes: expiracao ocorria apenas no front e nao havia timebox/idle no servidor.
- Depois: servidor valida timebox (12h), idle (30min) e reauth (15min), e o front limpa tokens ao receber SESSION_EXPIRED/REAUTH_REQUIRED.
- Antes: pagina de reset podia falhar com `securityConfig is not defined` ao validar captcha.
- Depois: hook de reset importa `securityConfig` e a validacao roda sem erro de referencia.
- Antes: sessao de recuperacao podia manter o usuario preso no reset mesmo ao voltar para o login.
- Depois: o reset limpa a sessao ao sair e permite voltar ao login quando nao for expiracao obrigatoria.
- Antes: /api/session/* usava fetch direto e parse manual.
- Depois: /api/session/* usa httpClient com envelope padronizado.
- Logs de sessao agora incluem contexto do erro (code/message/hint) para diagnostico no backend.
- Falhas 5xx no guard de sessao agora registram erro em api_errors (backend).
- Debug temporario: `SESSION_TOUCH_DEBUG=true` habilita log detalhado e resposta com stack no /api/session/touch.
- Quando o erro ocorre antes do handler (requireAuth), o debug retorna `context`/`stack` no /api/session/touch.
- Em 401/403 do /api/session/touch, o debug inclui dados de sessao (sessionId, origem do sessionId, token iat/exp, timestamps do registro e flags de expiracao).
- Migration corretiva adiciona colunas faltantes em `auth_session_activity` (ex.: `last_reauth_at`).
- Migration de indice permite multiplas linhas por sessao e garante apenas uma ativa (revoked_at IS NULL).

===========================================
Mapa de Codigo (funcoes, hooks e constantes)
===========================================

Funcoes principais
------------------
- LoginPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/LoginPage.jsx
  - Responsavel por: UI de login, aciona o hook de formulario e mostra feedbacks.
- useLoginForm
  - Tipo: hook de formulario
  - Caminho: src/hooks/useLoginForm.js
  - Responsavel por: estado de username/senha, submit, recuperacao de senha, mensagens de erro/sucesso.
- ResetPasswordPage
  - Tipo: componente de pagina React
  - Caminho: src/pages/ResetPasswordPage.jsx
  - Responsavel por: UI de redefinicao de senha consumindo hook dedicado.
- useResetPassword
  - Tipo: hook de reset
  - Caminho: src/hooks/useResetPassword.js
  - Responsavel por: restaurar sessao do link, validar senha/confirmacao, enviar update, limpar sessao ao sair e redirecionar.

Constantes e configuracoes
--------------------------
- LOCAL_AUTH (AuthContext)
  - Tipo: configuracao de modo local
  - Caminho: src/context/AuthContext.jsx
  - Uso: credenciais padrao em modo offline.
- TOUCH_THROTTLE_MS
  - Tipo: constante de throttle do touch
  - Caminho: src/context/AuthContext.jsx
  - Uso: limita chamadas de /api/session/touch a cada 45s.
- auth_session_activity
  - Tipo: tabela de controle de sessao
  - Caminho: supabase/migrations/20260211_auth_session_activity.sql
  - Uso: timebox (12h), idle (30min) e revogacao de sessao no backend.
- PASSWORD_MAX_AGE_MS
  - Tipo: constante de expiração de senha
  - Caminho: src/context/AuthContext.jsx
  - Uso: exige troca de senha apos 60 dias.

Funcoes utilitarias relacionadas
--------------------------------
- logError
  - Tipo: logger de erro
  - Caminho: src/services/errorLogService.js
  - Responsavel por: registrar falhas de login/recovery/reset em app_errors.

Servicos e integracoes externas
-------------------------------
- authService (sendPasswordRecovery, updatePassword, restoreResetSession)
  - Tipo: servico de Auth
  - Caminho: src/services/authService.js
  - Responsavel por: enviar email de recuperacao, atualizar senha e restaurar sessao via Supabase.
- AuthContext
  - Tipo: contexto de autenticacao
  - Caminho: src/context/AuthContext.jsx
  - Responsavel por: login (Supabase ou modo local), logout, recoverPassword, persistencia de sessao.
- validateSession / touchSession / markSessionReauth / revokeSession
  - Tipo: guard de sessao no backend
  - Caminho: api/_shared/sessionActivity.js
  - Responsavel por: validar timebox/idle/reauth, atualizar last_seen_at apenas no /touch e revogar sessao no logout.
- sessionService (touchSession, markSessionReauth, revokeSession, rotateSessionId, clearSessionId)
  - Tipo: servico de sessao no front
  - Caminho: src/services/sessionService.js
  - Responsavel por: enviar /api/session/touch, registrar reautenticacao, revogar sessao e rotacionar session_id por login.
- SessionReauthModal
  - Tipo: componente de modal
  - Caminho: src/components/SessionReauthModal.jsx
  - Responsavel por: coletar senha e reautenticar quando requerido.

